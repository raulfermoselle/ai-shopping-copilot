# Feature Specification: BrowserMCP Stock Pruning

<!--
  Generated by /speckit-specify
  Sprint Integration: This specification drives sprint task generation
-->

| Field | Value |
|-------|-------|
| Feature ID | 003-browsermcp-stock-pruning |
| Feature Branch | `feature/003-browsermcp-stock-pruning` |
| Created | 2026-01-19 |
| Status | Spec Ready |
| Target Sprint | TBD |

---

## Executive Summary

This specification connects existing StockPruner heuristics to the BrowserMCP workflow, enabling intelligent cart refinement by removing recently-purchased items that don't need reordering yet.

**Context:**
- **What exists**: StockPruner heuristics (1,223 lines), purchase history JSON (2000+ records), BrowserMCP cart merge (Sprint BrowserMCP-I-001)
- **The gap**: After merging 77 items into cart, pruning logic can't run because it needs cart data extraction and removal execution via BrowserMCP
- **User value**: Avoid accidentally reordering shower gel, vitamins, toothpicks, etc. that were bought recently

**Key Principle**: Purchase history maintenance is integral to pruning intelligence. Incremental sync ensures decisions use fresh data without manual updates.

---

## 1. User Stories & Journeys

### Story Priority Levels
- **P1**: Core workflow - Cart scanning, pruning, removal
- **P2**: Enhanced intelligence - LLM reasoning, detailed reporting
- **P3**: Future optimization - Learning from corrections

---

### User Story: [US1] Prune Recently-Purchased Items from Cart

**Priority**: P1

**As a** household shopper who runs `/merge-orders` weekly
**I want** the agent to automatically remove items I purchased recently
**So that** I don't reorder shower gel bought 8 days ago or vitamins bought 12 days ago

**Why this priority?**: Core value proposition - saves time by removing obvious non-candidates from merged cart.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Happy path | Cart has 77 items after merge, purchase history current | User runs `/prune-cart` | Agent removes ~30 high-confidence items, outputs JSON report with reasoning, final cart ~45 items |
| Uncertain items | 5 items have REVIEW classification (0.6-0.8 confidence) | Agent processes items | Agent outputs JSON report with heuristic + LLM reasoning, user handles via browser session or chat interface |
| No purchase history | User runs command without prior orders synced | Agent attempts pruning | Agent reports insufficient data, suggests running history sync first |
| All items needed | Cart items were last purchased >60 days ago | Agent applies heuristics | Agent keeps all items, reports low pruning confidence |
| Mixed quantities | Cart has 3x milk, last purchase was 5 days ago | Agent calculates urgency | Agent keeps milk (short cadence item), removes long-cadence items |

**Independent Testing Approach**:
- Can be developed without: Substitution agent, slot scouting, UI polish
- Requires: BrowserMCP cart access, purchase-history.json, existing heuristics.ts
- Test data: Real auchan.pt cart after merge, order history with known purchase dates

---

### User Story: [US2] Keep Purchase History Current

**Priority**: P1

**As a** shopper whose purchase patterns change over time
**I want** my order history automatically synced before each pruning run
**So that** pruning decisions reflect my actual recent purchases

**Why this priority?**: Stale data causes false removals (removes items actually needed) or false keeps (keeps items recently bought).

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Happy path | Last sync was 8 days ago, 2 new orders exist | Agent runs `/prune-cart` | Agent extracts 2 new orders, merges into JSON, uses fresh data for pruning |
| First sync | purchase-history.json doesn't exist | Agent runs `/prune-cart` | Agent creates file, extracts all available order history, proceeds with pruning |
| No new orders | Last sync was yesterday | Agent checks timestamp | Agent skips extraction, uses cached data |
| Extraction fails | Network timeout during order history fetch | Agent handles error | Agent falls back to cached data, logs warning, proceeds with caveat |

**Independent Testing Approach**:
- Can be developed without: Cart pruning logic
- Requires: BrowserMCP order history navigation, JSON merge logic
- Test data: Known order history, controlled sync timestamps

---

### User Story: [US3] LLM Validation of All Pruning Decisions

**Priority**: P1

**As a** user trusting the agent with my grocery cart
**I want** the LLM to validate ALL pruning decisions (not just uncertain ones)
**So that** heuristics don't miss contextual patterns that make high-confidence decisions wrong

**Why this priority?**: Heuristics can be **confidently wrong** when context matters. Deterministic cadence calculations miss:
- **Seasonality**: Summer vs winter consumption shifts (produce, ice cream, soups)
- **Life events**: New baby, new pet, dietary changes (items with sparse history suddenly become frequent)
- **Bundle relationships**: New item in cart implies related items also needed (flashlight → batteries)
- **Trend shifts**: Historical cadence doesn't reflect current household patterns (gym membership → protein shakes)

LLM validates all prune decisions to catch these edge cases **before** they're executed.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Seasonality override | Item has long historical cadence but current season implies increased need | LLM validates high-conf prune | LLM overrides: "Seasonal shift detected. Historical cadence doesn't apply in current context. Keep." |
| Bundle detection | Item marked for prune, related item present in cart | LLM validates | LLM overrides: "Related items in cart suggest this is needed. Keep." |
| Uncertain item reasoning | Item has ambiguous cadence (0.6 confidence) | LLM reviews | LLM provides context: "Depends on current stock at home. User should verify." |
| High-conf keep (safe skip) | Item has 0.8+ confidence KEEP (overdue) | LLM evaluates | LLM skips validation (safe - worst case we order something unnecessary, caught in user review) |
| Dev mode | Claude Code is running the command | Agent reasons directly | Claude Code (this conversation) validates without separate API call |
| Prod mode | Autonomous run via cron/scheduler | Agent calls LLM API | llm-enhancer.ts invokes configured LLM, returns reasoning |

**Independent Testing Approach**:
- Can be developed without: Full pruning workflow
- Requires: Pluggable LLM interface, sample prune candidates, contextual test data
- Test data: Mock cart with seasonal items, bundles, trend shifts, life event scenarios

---

## 2. Functional Requirements

> Focus on WHAT the system must do, not HOW it will be implemented.

### Core Capabilities

| ID | Requirement | User Story | Testable Criteria |
|----|-------------|------------|-------------------|
| FR001 | Agent can extract all items from current cart via BrowserMCP | US1 | Cart page parsed, returns list with name, quantity, price, productId |
| FR002 | Agent handles infinite-scroll cart loading | US1 | Triggers "view more" / "ver mais" button to load full cart before extraction, no items missed |
| FR003 | Agent matches cart items to purchase history by productId or name | US1 | 90%+ match rate for items with history, fuzzy matching for name variations |
| FR004 | Agent applies existing StockPruner heuristics without modification | US1 | Restock cadence, urgency ratio, confidence scores calculated correctly |
| FR005 | Agent generates baseline prune/keep decisions from heuristics | US1 | All items classified with confidence scores |
| FR006 | Agent invokes pluggable LLM layer to validate ALL prune decisions and uncertain items | US3 | LLM validates all items marked for pruning (any confidence) + uncertain items. Skips only high-confidence KEEP |
| FR007 | LLM can override heuristic decisions with contextual reasoning | US3 | LLM detects seasonality, bundles, trends, life events that heuristics miss |
| FR008 | Agent removes LLM-validated items from cart via BrowserMCP | US1 | Items disappear from cart, cart total updates correctly |
| FR009 | Agent incrementally syncs order history before pruning | US2 | Only new orders extracted, existing records preserved, timestamps updated |
| FR010 | Agent creates purchase-history.json if missing | US2 | Fresh file created with all available order data |
| FR011 | Agent generates summary report with removal reasoning | US1 | Report shows removed items, kept items, heuristic + LLM reasoning, final cart state |
| FR012 | Agent logs all removal decisions with dual reasoning | US1, US3 | Audit trail includes item name, heuristic decision, LLM validation, final confidence, timestamp |
| FR013 | Agent outputs JSON report for uncertain items | US1, US3 | JSON file contains items with both heuristic and LLM reasoning. User manipulates browser session directly or provides approval via chat interface. No interactive UX required. |

### Business Rules

| ID | Rule | Applies To | Exception |
|----|------|------------|-----------|
| BR001 | Agent never touches checkout or payment flow | All operations | No exceptions - safety constraint |
| BR002 | Purchase history sync is incremental (only new orders) | US2 | First run extracts all available history |
| BR003 | LLM layer is pluggable (dev vs prod modes) | US3 | Dev: Claude Code direct. Prod: llm-enhancer API |
| BR004 | Heuristics run first, LLM validates ALL prune decisions and uncertain items | US3 | Only high-confidence KEEP decisions skip LLM (safe - worst case we order something unnecessary) |
| BR005 | LLM can override heuristic decisions when contextual reasoning is stronger | US3 | LLM confidence must exceed heuristic confidence to override |
| BR006 | All removals are reversible via `/merge-orders` | US1 | User can restore cart by re-running merge |
| BR007 | Agent stops on unrecoverable errors (network, auth) | US2 | Falls back to cached data with warning if extraction fails |

---

## 3. Key Entities

### Cart Item

**Description**: Product currently in the user's auchan.pt shopping cart

| Attribute | Type | Required | Notes |
|-----------|------|----------|-------|
| productName | string | Yes | Display name from cart page |
| productId | string | Optional | Auchan SKU if available |
| quantity | integer | Yes | Number of units in cart |
| unitPrice | decimal | Yes | Price per unit (€) |
| totalPrice | decimal | Yes | quantity × unitPrice |

### Purchase History Record

**Description**: Record of a product purchased in a past order

| Attribute | Type | Required | Notes |
|-----------|------|----------|-------|
| productName | string | Yes | Name at time of purchase |
| productId | string | Optional | Auchan SKU |
| purchaseDate | ISO date | Yes | Order delivery/completion date |
| quantity | integer | Yes | Units purchased |
| unitPrice | decimal | Yes | Price paid per unit |
| orderId | string | Yes | Reference to parent order |

**State Transitions**: None (immutable historical records)

### Pruning Decision

**Description**: Agent's determination about whether to keep or remove a cart item

| Attribute | Type | Required | Notes |
|-----------|------|----------|-------|
| productName | string | Yes | Name of the product being evaluated |
| productId | string | Optional | Auchan SKU if available |
| prune | boolean | Yes | Heuristic recommendation (true = remove, false = keep) |
| confidence | decimal (0-1) | Yes | Heuristic confidence in decision |
| reason | string | Yes | Human-readable explanation from heuristics |
| decision | enum | Yes | **KEEP** (conf <0.6), **REVIEW** (conf 0.6-0.8), **AUTO_REMOVE** (conf >0.8). Mapping based on heuristic confidence. LLM validates REVIEW + AUTO_REMOVE items. |
| context | object | Yes | Heuristic details (restockCadence, urgencyRatio, daysSince, cadenceSource, category, matchCount) |
| llmReasoning | string | Optional | Enhanced explanation from LLM (for validated items) |
| llmConfidenceAdjustment | decimal | Optional | LLM's confidence adjustment from heuristic baseline |
| wasLLMEnhanced | boolean | Yes | Whether LLM validated this decision |

### Purchase History Sync Status

**Description**: Metadata about most recent order history extraction

| Attribute | Type | Required | Notes |
|-----------|------|----------|-------|
| lastSyncTimestamp | ISO datetime | Yes | When extraction last ran |
| ordersCaptured | integer | Yes | Total orders in history file |
| recordCount | integer | Yes | Total product records |
| lastOrderDate | ISO date | Optional | Most recent order in history |

---

## 4. Responsibility Boundaries

| Component | Responsibilities | Does NOT Handle |
|-----------|------------------|-----------------|
| **Claude Code (Dev)** | - Orchestrates workflow<br>- Validates ALL prune decisions + uncertain items<br>- Generates JSON reports | - Production automation<br>- Scheduled runs |
| **BrowserMCP** | - Navigates auchan.pt pages<br>- Extracts DOM data<br>- Clicks remove buttons | - Business logic<br>- Pruning decisions<br>- Data persistence |
| **StockPruner Heuristics** | - Calculates restock cadence<br>- Scores urgency ratio<br>- Assigns baseline confidence | - Cart extraction<br>- History sync<br>- Item removal |
| **LLM Layer (Pluggable)** | - Validates ALL prune decisions<br>- Validates uncertain items<br>- Provides contextual reasoning<br>- Can override heuristics with stronger confidence | - Primary decision-making without heuristic baseline<br>- Validates high-confidence KEEP (safe to skip) |
| **User** | - Reviews JSON report<br>- Handles uncertain items via browser/chat<br>- Provides login credentials | - Data extraction<br>- Heuristic calculations<br>- Cart modifications |

---

## 5. Success Criteria

### Primary (Infrastructure & Correctness)

| Criterion | Target | Acceptable Range | Measurement |
|-----------|--------|------------------|-------------|
| Cart extraction accuracy | 100% of visible items extracted | 95-100% | Manual verification against cart page |
| History sync completeness | All new orders captured | 100% | Compare JSON records to order history page |
| Item matching accuracy | 90% of items matched to history | 85-100% | Review match results for sample cart |
| Heuristic accuracy | 85% of removals validated as correct | 80-90% | User feedback on whether removed items were actually needed |
| LLM reasoning quality | 80% of uncertain items have helpful explanations | 70-90% | User subjective rating |

### Secondary (Operational Quality)

| Criterion | Target | Acceptable Range | Measurement |
|-----------|--------|------------------|-------------|
| Execution time | < 3 minutes for typical 77-item cart | 2-5 minutes | Time from command start to JSON report output |
| Token consumption | < 50k tokens per run | 30k-70k | BrowserMCP snapshot sizes, LLM API calls |
| JSON report generation | Report written to file within 5 seconds | 2-10 seconds | Time from pruning complete to JSON file ready |
| Cart reduction rate | ~40% of merged items removed | 30-50% | finalCartSize / initialCartSize |

### Acceptance Criteria

**The feature is successful when:**
1. User can run `/prune-cart` on a merged cart and see intelligent removals
2. All removals have clear, auditable reasoning in JSON report
3. Purchase history stays current without manual CSV imports
4. Works in both interactive (Claude Code) and autonomous modes
5. Uncertain items are documented in JSON with heuristic + LLM reasoning
6. User can handle uncertain items via browser session or future chat interface

---

## 6. Known Constraints

| Constraint | Impact | Mitigation |
|------------|--------|------------|
| Auchan.pt selector stability | Cart selectors may change, breaking extraction | Use selector registry pattern from BrowserMCP-I-001 |
| Purchase history size | 2000+ records → large file, slow parsing | Implement pagination in extraction, index by productId |
| LLM API cost | Prod mode incurs per-item reasoning cost (~25 items/cart) | Accepts higher cost for accuracy - validates ALL prune decisions + uncertain items to catch seasonality/bundle edge cases |
| Item name variations | "Milk 1L" vs "Leite 1L" → match failures | Fuzzy matching with similarity threshold |
| Network timeouts | Order history extraction may fail | Fall back to cached data, proceed with warning |

---

## 7. Out of Scope (Future Specs)

- **Learning from corrections**: Capturing user keep/remove overrides to improve heuristics
- **Quantity reduction**: Reducing quantities (2x → 1x) instead of full removal
- **Substitution suggestions**: Recommending alternatives for removed items
- **Purchase history refresh automation**: Scheduled background syncs
- **Multi-household support**: Different pruning rules per household member
- **Category-based rules**: User-configurable cadences per category

---

## 8. Integration Points

### Upstream Dependencies
- **BrowserMCP-I-001** (002-browsermcp-cart-merge): Provides merged cart to prune
- **StockPruner Heuristics** (src/agents/stock-pruner/heuristics.ts): Provides decision logic
- **LLM Enhancer** (src/llm/llm-enhancer.ts): Provides pluggable LLM interface

### Downstream Consumers
- Future: Substitution agent (uses pruning decisions to suggest alternatives)
- Future: Review pack generator (includes pruning summary)

### Data Dependencies
- **Input**: purchase-history.json (read/write)
- **Input**: BrowserMCP cart page data
- **Output**: Pruning decision log (audit trail)
- **Output**: Updated purchase-history.json (incremental sync)

---

## 9. Quality Gates

Before marking tasks complete:
1. ✅ All FR items have passing tests
2. ✅ Sample 77-item cart reduces to 40-50 items with clear reasoning
3. ✅ Purchase history sync adds new orders without duplicating existing records
4. ✅ LLM layer works in both dev (Claude Code) and prod (API) modes
5. ✅ JSON report generation works (uncertain items documented with dual reasoning)
6. ✅ Removal execution is reliable (no phantom items, cart totals correct)
7. ✅ Error handling: graceful degradation on network failures
8. ✅ Audit trail: all decisions logged with confidence and reasoning

---

## 10. Open Questions

None - all clarifications resolved during spec-seed discussion.

---

**Next Steps:**
1. Review this spec for accuracy and completeness
2. Run `/speckit-plan 003-browsermcp-stock-pruning` to generate implementation plan
3. Run `/speckit-tasks 003-browsermcp-stock-pruning` to generate task breakdown
