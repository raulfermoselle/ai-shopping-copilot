# Feature Specification: BrowserMCP Cart Merge (Agentic Baseline)

<!--
  Generated by /speckit-specify
  Template: spec-template.md
  Sprint Integration: This specification drives sprint task generation
-->

| Field | Value |
|-------|-------|
| Feature ID | 002-browsermcp-cart-merge |
| Feature Branch | `feature/002-browsermcp-cart-merge` |
| Created | 2026-01-18 |
| Status | Tasks Ready |
| Target Sprint | TBD |

---

## Executive Summary

This specification defines the **first minimal, end-to-end user story** that validates the BrowserMCP-based agentic architecture for the AI Shopping Copilot.

**Architectural Pivot Context:**
- **Away from**: Playwright-only closed automation and Chrome extension-driven models
- **Toward**: BrowserMCP-based setup where **Claude Code is the primary consumer and operator**
- **Purpose**: Validate that Claude Code can autonomously understand, explore, and operate auchan.pt

**Key Principle**: For the foreseeable future, Claude Code must be able to directly drive, observe, inspect, and manipulate the browser session with full transparency and minimal human input.

---

## 1. User Stories & Journeys

### Story Priority Levels
- **P1**: Core functionality - Required for infrastructure validation
- **P2**: Enhanced functionality - Improves agent autonomy
- **P3**: Nice-to-have - Future enhancement

---

### User Story: [US1] Load Past Orders Into Cart

**Priority**: P1

**As a** user who shops regularly on auchan.pt
**I want** the agent to load my past three orders into the current cart
**So that** I start from a meaningful baseline instead of an empty cart

**Why this priority?**: This is the anchor story that validates the entire BrowserMCP infrastructure. Success here proves that Claude Code can autonomously navigate, understand, and manipulate a third-party e-commerce site.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Happy path | User is logged into auchan.pt with order history | Agent executes cart merge | Cart contains items from last 3 orders, agent can verify cart state |
| Partial orders | Only 1-2 previous orders exist | Agent executes cart merge | Cart contains items from available orders, agent reports actual count |
| No orders | User has no order history | Agent attempts cart merge | Agent reports no orders found, cart remains unchanged |
| Session expired | User session times out mid-operation | Agent detects session loss | Agent stops, reports authentication required, waits for human to re-login |
| Items unavailable | Some ordered items no longer exist | Agent completes merge | Cart contains available items, agent reports which items were unavailable |

**Independent Testing Approach**:
- Can be developed without: UI polish, user-facing controls, optimization heuristics
- Requires: BrowserMCP connection to browser where user is already logged in, network access
- Test data: Real auchan.pt account with existing order history (user handles login)

---

### User Story: [US2] Full Observability for Claude Code

**Priority**: P1

**As** Claude Code (the autonomous agent)
**I want** complete visibility into browser state, DOM structure, and navigation outcomes
**So that** I can perform trial-and-error exploration and self-correct without human relay

**Why this priority?**: Without observability, the agent cannot learn, debug, or adapt. This is foundational to autonomous operation.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| DOM inspection | Agent needs to understand page structure | Agent requests DOM snapshot | Agent receives parseable DOM representation |
| Screenshot capture | Agent needs visual confirmation | Agent requests screenshot | Agent receives viewable image of current page state |
| URL awareness | Agent navigates to new page | Navigation completes | Agent can query and verify current URL |
| Element discovery | Agent needs to find interactive elements | Agent queries for buttons/links | Agent receives list of actionable elements with identifiers |
| State verification | Agent performs an action | Action completes | Agent can verify resulting page state independently |

**Independent Testing Approach**:
- Can be developed without: Specific auchan.pt knowledge, cart logic
- Requires: BrowserMCP with inspection capabilities
- Test data: Any web page for basic validation

---

### User Story: [US3] Autonomous Operation During Human Absence

**Priority**: P1

**As a** user who may step away during execution
**I want** the agent to continue operating and recover from transient failures
**So that** I don't need to babysit the automation process

**Why this priority?**: The value proposition of an agentic system is reduced human involvement. The agent must handle routine obstacles independently.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Transient failure | Action doesn't produce expected state | Agent verifies state and diagnoses | Agent inspects DOM/console, understands issue, decides next steps autonomously |
| UI state change | Unexpected modal appears | Agent detects obstruction | Agent inspects modal, attempts to dismiss or reports blocker with context |
| Multi-step completion | Agent is mid-operation | Human is absent | Agent completes full operation or reaches a clear stopping point |
| Unrecoverable error | Fatal error occurs | Agent cannot proceed | Agent stops cleanly and logs full context for human review |

**Independent Testing Approach**:
- Can be developed without: Complete happy-path implementation
- Requires: Error injection capability, logging infrastructure
- Test data: Scenarios that trigger each error type

---

## 2. Functional Requirements

> Focus on WHAT the system must do, not HOW it will be implemented.

### Core Capabilities

| ID | Requirement | User Story | Testable Criteria |
|----|-------------|------------|-------------------|
| FR001 | Agent has bidirectional access to BrowserMCP capabilities (issue actions, receive results) | US1, US2, US3 | Agent can invoke browser actions and receive observable feedback |
| FR002 | Agent can navigate to arbitrary URLs | US1, US2 | URL changes and agent can verify new location |
| FR003 | Agent can capture current page screenshot | US2 | Screenshot file is produced and viewable |
| FR004 | Agent can extract DOM structure or element list | US2 | Agent receives parseable representation of page content |
| FR005 | Agent can interact with page elements (click, type, select) | US1 | Actions produce expected state changes |
| FR006 | Agent can query current cart contents | US1 | Agent can enumerate items in cart with quantities |
| FR007 | Agent can verify authentication state | US1, US3 | Agent confirms user is logged in before proceeding (does not handle login) |
| FR008 | Agent verifies state after actions and diagnoses failures intelligently | US3 | Agent inspects DOM/console to understand failures, decides next steps autonomously (not mechanical retries) |
| FR009 | Agent can log all actions and observations for later review | US2, US3 | Complete audit trail exists |
| FR010 | Agent reports outcomes in natural language narrative | US1 | Agent explains what it did, what it observed, and its confidence (e.g., "I merged 3 orders. Cart has 47 items. 2 items were unavailable.") |

### Business Rules

| ID | Rule | Applies To | Exception |
|----|------|------------|-----------|
| BR001 | Agent must never place an order or proceed to checkout | All operations | No exceptions - safety constraint |
| BR002 | Agent does not handle authentication | Authentication | User logs in manually; agent only verifies auth state |
| BR003 | Agent must stop on unrecoverable errors rather than guess | US3 | Clear stopping point with context preserved |
| BR004 | Prior codebase knowledge may inform but must not constrain | All | Agent may discover selectors/flows differ from prior code |
| BR005 | Order selection is most recent 3 by order date | US1 | Regardless of order status (delivered, cancelled, etc.) |
| BR006 | Cart merge behavior is platform-driven | US1 | Empty cart: items added directly. Non-empty cart: platform prompts merge without duplicates. Agent follows platform flow. |

---

## 3. Key Entities

### Entity: Browser Session

**Description**: The live browser instance controlled via BrowserMCP

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| session_id | Unique identifier for the session | Yes | Assigned by BrowserMCP |
| current_url | The URL currently loaded | Yes | Valid URL or empty |
| is_authenticated | Whether user is logged into auchan.pt | Yes | Boolean, may change during session |
| last_screenshot | Most recent page capture | No | Image data or path |
| last_dom_snapshot | Most recent DOM extraction | No | Parseable structure |

**State Transitions**:
```
[Not Started] --launch--> [Running] --navigate--> [Running]
                              |
                        --close/error--> [Terminated]
```

---

### Entity: Cart State

**Description**: The current contents of the auchan.pt shopping cart

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| items | List of products in cart | Yes | May be empty |
| item_count | Total number of distinct items | Yes | Integer >= 0 |
| total_quantity | Sum of all item quantities | Yes | Integer >= 0 |
| estimated_total | Cart total if displayed | No | Currency amount |
| unavailable_items | Items that could not be added | No | List with reasons |

---

### Entity: Order History Entry

**Description**: A previous order that can be merged into cart

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| order_id | Identifier for the order | Yes | As displayed on auchan.pt |
| order_date | When the order was placed | Yes | Date value |
| item_count | Number of items in that order | Yes | Integer > 0 |
| merge_status | Whether this order was merged | No | pending/merged/failed |

---

### Entity: Agent Action Log

**Description**: Record of actions taken and observations made

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| timestamp | When the action occurred | Yes | ISO timestamp |
| action_type | Category of action | Yes | navigate/click/type/observe/screenshot/etc |
| target | What was acted upon | No | Element identifier, URL, etc |
| outcome | Result of the action | Yes | success/failure/partial |
| observation | What the agent saw after | No | Free text or structured data |

---

## 4. Responsibility Boundaries

This section defines who is responsible for what.

### Claude Code (Autonomous Agent)

**Responsible for:**
- Deciding which actions to take based on observations
- Interpreting page structure and finding interactive elements
- Sequencing operations to achieve the goal
- Verifying state after each action (did it work?)
- Diagnosing failures intelligently (inspect DOM/console, understand why)
- Deciding next steps autonomously based on diagnosis
- Knowing when to stop and request human help

**Not responsible for:**
- Low-level browser control (delegated to BrowserMCP)
- Credential management (user logs in manually)
- Guaranteeing site stability (external dependency)

---

### BrowserMCP (Browser Control Layer)

**Responsible for:**
- Providing bidirectional access to browser capabilities
- Executing navigation, click, type commands
- Capturing screenshots and DOM snapshots
- Reporting command success/failure and observable results
- Providing element inspection and console access

**Not responsible for:**
- Deciding what to click or where to navigate
- Understanding auchan.pt-specific logic
- Error diagnosis or recovery (agent's job)

---

### Human User

**Responsible for:**
- Logging into auchan.pt manually before starting (agent connects to existing session)
- Initiating the operation ("please merge my past orders")
- Reviewing final cart state before any checkout
- Re-authenticating if session expires during operation
- Handling unrecoverable errors flagged by agent

**Not responsible for:**
- Guiding each step of the automation
- Providing selectors or DOM paths
- Being present during execution

---

## 5. Success Criteria

> Technology-agnostic, measurable outcomes.

### Primary Success: Infrastructure Validation

| Criterion | Definition | Measurement |
|-----------|------------|-------------|
| Agent can explore | Claude Code navigates auchan.pt, discovers elements, takes actions | Agent completes multi-step navigation without hardcoded paths |
| Agent can observe | Claude Code inspects DOM, captures screenshots, verifies state | Agent describes page content accurately from inspection |
| Agent can act | Claude Code performs clicks, types, selects on the site | Actions produce expected state changes |
| Agent can verify | Claude Code confirms cart contents match expectations | Agent reports cart state with confidence |

### Secondary Success: Operational Quality

| Criterion | Target | Acceptable |
|-----------|--------|------------|
| Merge completion rate | 90% of attempts complete successfully | 70% |
| False confidence rate | Agent rarely claims success when it failed | <10% |
| Human intervention rate | Agent completes without asking for help | <20% of runs |
| Recovery rate | Agent recovers from transient errors | 80% of transient errors |

### What "Success" Means for First Run

At the end of a successful run:

1. **Browser State**: Session is still active (not crashed), on a known auchan.pt page
2. **Cart State**: Contains items from 1-3 previous orders (depending on availability)
3. **Agent Confidence**: Agent can articulate:
   - How many orders it found
   - How many orders it merged
   - What items are now in cart
   - Whether any items were unavailable
   - Any anomalies or uncertainties encountered

---

## 6. Assumptions and Constraints

### Operating on Third-Party E-Commerce UI

| Assumption/Constraint | Implication |
|----------------------|-------------|
| No public API | All interactions must go through browser UI |
| Frontend may change | Selectors and flows may break without notice |
| Session may expire | Agent must detect auth loss and stop for human re-login |
| Rate limiting possible | Agent should not flood the site with requests |
| Items may be unavailable | Previously ordered items may no longer exist |
| Prices may change | Cart totals may differ from original orders |
| User pre-authenticates | Agent connects to existing logged-in session via BrowserMCP |

### Prior Codebase Knowledge

| Context | Implication |
|---------|-------------|
| Existing selectors exist | May inform exploration but must not constrain it |
| Previous Playwright flows exist | May provide hints but agent should verify current behavior |
| Cart-merge logic exists | Conceptual approach may transfer, implementation may differ |
| Extension code abandoned | Not reusable for this approach |

---

## 7. Out of Scope

> Explicitly list what is NOT included in this feature.

| Item | Reason |
|------|--------|
| Detailed implementation steps | This is a spec, not a plan |
| Concrete selector strategies | Agent must discover these |
| URL/DOM specifics | May change; agent adapts |
| Login automation | User logs in manually; agent connects to existing session |
| Substitution heuristics | Future feature |
| Quantity optimization | Future feature |
| Stock pruning | Future feature |
| User-facing UI | Future layer |
| Checkout or payment | Safety constraint - never in scope |
| Multi-account support | Single user for now |
| Performance optimization | Get it working first |

---

## 8. Design Decisions

> Key decisions integrated into this specification.

- **BrowserMCP connection mechanism**: Intentionally unspecified. Spec only requires bidirectional access to capabilities. Connection topology (MCP server config, local process, or separate service) is a plan/design concern.

- **Prior code reuse**: No constraint. Agent may discover flows have changed. Prior Playwright code is informational, not prescriptive.

- **BrowserMCP capability assumptions**: This spec assumes BrowserMCP provides navigation, click, type, screenshot, and DOM inspection. Capability gaps become blocking issues.

---

## 9. Future Considerations (Out of Scope)

These are architecturally relevant but not part of this spec:

- **Pluggable interface**: The BrowserMCP interaction layer should be abstract enough that a future user-facing agent or UI could replace Claude Code
- **Learning from failures**: Agent observations could feed into a knowledge base for future runs
- **Parallel operations**: Multiple agents or faster execution
- **Richer heuristics**: Substitution, pruning, quantity estimation

---

## 10. Sprint Integration

### Estimated Effort

| Component | Story Points | Notes |
|-----------|-------------|-------|
| US1: Cart Merge | 8 | Core operation, depends on US2 |
| US2: Observability | 5 | Foundation for all agent work |
| US3: Autonomous Operation | 5 | Error handling, retry, logging |
| Integration Testing | 3 | End-to-end validation |
| **Total** | **21** | |

### Sprint Allocation Recommendation

**Recommended: 2 sprints**

- **Sprint 1** (13 points): US2 (Observability) + US3 (Autonomous Operation) + Setup
  - Establish BrowserMCP connection
  - Build observation/inspection capabilities
  - Implement error handling and logging

- **Sprint 2** (8 points): US1 (Cart Merge) + Integration Testing
  - Implement the actual cart merge operation
  - End-to-end testing on auchan.pt

### Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| BrowserMCP capabilities | Required | Bidirectional access to browser actions and observable feedback (connection mechanism TBD in plan phase) |
| Existing browser session | Required | User has already logged into auchan.pt manually |
| Network access | Required | Must reach auchan.pt |

---

<!-- SPECKIT METADATA - DO NOT EDIT BELOW -->
```yaml
speckit:
  version: "1.0"
  template: "spec-template"
  stories:
    - id: US1
      title: "Load Past Orders Into Cart"
      priority: P1
      points: 8
      status: draft
    - id: US2
      title: "Full Observability for Claude Code"
      priority: P1
      points: 5
      status: draft
    - id: US3
      title: "Autonomous Operation During Human Absence"
      priority: P1
      points: 5
      status: draft
  requirements_count: 10
  business_rules_count: 6
  design_decisions_count: 3
  total_points: 21
  sprint_recommendation: 2
  sprint_ready: true
```
