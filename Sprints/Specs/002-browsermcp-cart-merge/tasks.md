# Tasks: BrowserMCP Cart Merge (Agentic Baseline)

<!--
  Generated by /speckit-tasks
  Template: tasks-template.md
  Sprint Integration: Maps directly to SPRINT-PLAN.md tasks
-->

| Field | Value |
|-------|-------|
| Feature Branch | `feature/002-browsermcp-cart-merge` |
| Generated | 2026-01-18 |
| Source Plan | [plan.md](./plan.md) |
| Target Sprint(s) | Single sprint |
| Total Tasks | 15 |

---

## Task Format

```
- [ ] [TaskID] [P] [Story] Description | file/path
```

- `[ ]` - Checkbox (mandatory)
- `[TaskID]` - T001, T002, etc.
- `[P]` - Parallelizable marker (only if task can run concurrently)
- `[Story]` - Phase/story reference
- Description - Clear action with context

---

## Phase 0: Setup

> One-time BrowserMCP configuration. Must complete before any automation work.

**Sprint Allocation**: Sprint start

- [x] T001 [SETUP] Install BrowserMCP Chrome extension in dedicated profile
- [x] T002 [SETUP] Configure MCP server in Claude Code settings (`mcpServers.browsermcp`)
- [x] T003 [SETUP] Verify BrowserMCP connection (screenshot test)

**Phase 0 Complete Criteria**:
- [x] Chrome profile created with auchan.pt login
- [x] BrowserMCP extension connected to tab
- [x] Claude Code can call BrowserMCP tools and interact with page

**Completion Note**: Phase 0 completed manually on 2026-01-18. BrowserMCP extension installed, MCP server configured, connection verified via screenshot test.

---

## Phase 1: Exploration Harness (US2)

> Build the state capture pattern that enables autonomous debugging.

**Sprint Allocation**: After setup
**FR Coverage**: FR003, FR004, FR009

### Discovery & Validation

- [x] T004 [US2] ~~Discover BrowserMCP tool names and capabilities~~ (Confirmed: 12 tools available, no browser_evaluate)
- [ ] T005 [US2] Implement capture_state pattern (screenshot + snapshot + URL + console)
- [ ] T006 [US2] Create artifact persistence structure (`runs/{timestamp}/{step}/`)

**Phase 1 Complete Criteria**:
- [ ] capture_state produces viewable screenshot
- [ ] DOM/accessibility snapshot parseable
- [ ] Artifacts persisted to `runs/` folder
- [ ] Claude Code can read artifacts and describe page content

---

## Phase 2: Cart Merge Workflow (US1)

> Implement the core user story - load last 3 orders into cart.

**Sprint Allocation**: Main implementation phase

**Test-First Compliance (Article III)**: The `capture_state` pattern serves as continuous validation for exploratory automation. Each task implicitly follows: (1) define expected state, (2) execute action, (3) capture and verify state. This satisfies test-first principles - verification is built into every step rather than being a separate artifact.
**FR Coverage**: FR001, FR002, FR005, FR006, FR007, FR010
**BR Coverage**: BR001, BR002, BR005, BR006

### Authentication & Navigation

- [ ] T007 [US1] Implement auth verification (detect logged-in state)
- [ ] T008 [US1] Navigate to order history (discover URL pattern)

### Order Processing

- [ ] T009 [US1] Extract and identify last 3 orders from page
- [ ] T010 [US1] Implement order merge loop (oldest first, handle platform prompts, classify errors: network/selector/auth/unknown)

### Cart Verification

- [ ] T011 [US1] Navigate to cart and extract cart contents
- [ ] T012 [US1] Generate natural language report (orders found, merged, items, unavailable)

**Phase 2 Complete Criteria**:
- [ ] Agent navigates to order history without hardcoded selectors
- [ ] Agent identifies and merges up to 3 orders
- [ ] Agent follows platform merge prompts (BR006)
- [ ] Agent reports cart state with confidence
- [ ] capture_state called after each significant step

---

## Phase 3: Safety Guardrails (US3)

> Ensure agent NEVER proceeds to checkout and produces Review Pack.

**Sprint Allocation**: Final implementation phase
**FR Coverage**: FR008, FR010
**BR Coverage**: BR001, BR003

### Safety Implementation

- [ ] T013 [US3] Implement checkout button blocker (red button detector)
- [ ] T014 [US3] Generate Review Pack (cart diff, screenshots, action timeline)

### End-to-End Validation

- [ ] T015 [US3] Full workflow validation (auth → orders → merge → report → stop)

**Phase 3 Complete Criteria**:
- [ ] Agent refuses to click checkout/confirm buttons
- [ ] Review Pack contains cart diff and screenshots
- [ ] Agent explicitly states "Stopping before checkout"
- [ ] Full workflow completes autonomously from logged-in state

---

## Execution Strategy

### Recommended: Sequential Phases

This feature has tightly coupled phases - each builds on the previous:

1. **Phase 0** (Setup): One-time, must complete first
2. **Phase 1** (Harness): Enables debugging for all subsequent work
3. **Phase 2** (Workflow): Core functionality, uses harness throughout
4. **Phase 3** (Guardrails): Wraps workflow with safety constraints

### Iteration Approach

Within each phase:
1. Attempt task
2. Call capture_state
3. If failed: read artifacts, diagnose, adjust
4. Repeat until task succeeds

This is the autonomous debugging loop that replaces human relay.

---

## Dependency Graph

```
Phase 0: Setup
T001 ─> T002 ─> T003
                  │
                  v
Phase 1: Harness
T004 ─> T005 ─> T006
                  │
                  v
Phase 2: Workflow
T007 ─> T008 ─> T009 ─> T010 ─> T011 ─> T012
                                          │
                                          v
Phase 3: Guardrails
T013 ─> T014 ─> T015
```

**Note**: No parallelization within phases - each step depends on previous.
However, Claude Code can work on multiple aspects of a single task concurrently.

---

## Sprint Integration Summary

### Single Sprint Tasks

| Phase | Task Range | Count | Points |
|-------|------------|-------|--------|
| Setup | T001-T003 | 3 | 3 |
| Harness (US2) | T004-T006 | 3 | 5 |
| Workflow (US1) | T007-T012 | 6 | 8 |
| Guardrails (US3) | T013-T015 | 3 | 5 |
| **Total** | T001-T015 | **15** | **21** |

---

## Task-to-Sprint Mapping

> Copy to SPRINT-PLAN.md

```markdown
## Task Breakdown

| ID | Task | Phase | Status |
|----|------|-------|--------|
| T001 | Install BrowserMCP extension | Setup | PENDING |
| T002 | Configure MCP server | Setup | PENDING |
| T003 | Verify BrowserMCP connection | Setup | PENDING |
| T004 | Discover BrowserMCP capabilities | Harness | PENDING |
| T005 | Implement capture_state pattern | Harness | PENDING |
| T006 | Create artifact persistence | Harness | PENDING |
| T007 | Implement auth verification | Workflow | PENDING |
| T008 | Navigate to order history | Workflow | PENDING |
| T009 | Extract last 3 orders | Workflow | PENDING |
| T010 | Implement order merge loop | Workflow | PENDING |
| T011 | Extract cart contents | Workflow | PENDING |
| T012 | Generate natural language report | Workflow | PENDING |
| T013 | Implement checkout blocker | Guardrails | PENDING |
| T014 | Generate Review Pack | Guardrails | PENDING |
| T015 | Full workflow validation | Guardrails | PENDING |
```

---

## Acceptance Criteria Mapping

| Task | Acceptance Criteria |
|------|---------------------|
| T003 | Screenshot received from BrowserMCP |
| T006 | Artifacts readable in `runs/` folder |
| T007 | Agent detects logged-in vs logged-out state |
| T009 | Agent extracts order dates and selects 3 most recent |
| T010 | Platform merge prompts handled correctly |
| T012 | Report includes: orders found, merged, items, unavailable |
| T013 | Click blocked on checkout/confirm buttons |
| T015 | Full workflow: auth→orders→merge→report→stop |

---

## Notes for Implementation

### BrowserMCP Tool Discovery (T004)

Claude Code should explore available tools:
- List all MCP tools available
- Document actual tool names (may differ from assumed)
- Note any capability gaps

### URL-First Navigation (T008)

Prefer discovering URL patterns:
- `/conta/encomendas` or similar for orders
- `/carrinho` or similar for cart
- Document discovered URLs for future reference

### Platform Merge Behavior (T010)

Follow auchan.pt's native flow:
- Empty cart: items added directly
- Non-empty cart: platform prompts merge
- Don't fight the platform - follow its prompts

### Checkout Blocker Patterns (T013)

Block clicks matching:
- Text: "confirm", "place order", "pay", "checkout", "finalizar", "confirmar", "pagar"
- Aria labels with above patterns
- Elements on checkout/payment pages

---

<!-- SPECKIT METADATA - DO NOT EDIT BELOW -->
```yaml
speckit:
  version: "1.0"
  template: "tasks-template"
  source_plan: "002-browsermcp-cart-merge/plan.md"
  task_summary:
    total: 15
    setup: 3
    harness: 3
    workflow: 6
    guardrails: 3
  parallelizable: 0
  sprint_mapping:
    - sprint: "BrowserMCP-I-001"
      tasks: ["T001-T015"]
  points: 21
```
