# Implementation Plan: BrowserMCP Cart Merge (Agentic Baseline)

<!--
  Generated by /speckit-plan
  Template: plan-template.md
  Sprint Integration: This plan drives task generation for sprints
-->

| Field | Value |
|-------|-------|
| Feature Branch | `feature/002-browsermcp-cart-merge` |
| Created | 2026-01-18 |
| Source Spec | [spec.md](./spec.md) |
| Target Sprint(s) | Single sprint (revised approach) |

---

## 1. Summary

**Primary Requirement**: Claude Code must be able to autonomously load the user's past 3 orders from auchan.pt into the current cart, using BrowserMCP for browser control, with full observability and the ability to operate while the human is away.

**Technical Approach**:
- Use BrowserMCP (MCP server + Chrome extension) to control the user's actual Chrome browser via CDP
- Build a minimal "exploration harness" that captures state (screenshot, DOM snapshot, URL, console) after every step
- Claude Code drives the workflow directly via MCP tool calls - no intermediate orchestration layer
- Prefer URL-based navigation over DOM scraping where possible
- Persist every run as artifacts for debugging without human relay

**Key Insight from GPT-5.2 Plans**:
- The browser is a **persistent, remote-controlled resource**, not a closed test runner
- Browser NEVER auto-closes; human may interact at any time; agent must tolerate interference
- All browser control endpoints must be **synchronous, observable, and replayable**

**Sprint Scope**: Single sprint with phased delivery
- Phase 0: Setup (BrowserMCP configuration, Chrome profile)
- Phase 1: Exploration Harness (capture_state, artifact persistence)
- Phase 2: Cart Merge Workflow (order history → merge → verify cart)
- Phase 3: Safety Guardrails (checkout blocker, Review Pack generation)

---

## 2. Technical Context

### Project Classification

| Aspect | Value |
|--------|-------|
| Project Type | New (infrastructure pivot) |
| Complexity | Medium |
| Risk Level | Medium (external site dependency) |

### Technology Stack

| Layer | Technology | Notes |
|-------|------------|-------|
| Agent | Claude Code | Primary operator via MCP tools |
| Browser Control | BrowserMCP | MCP server + Chrome extension |
| Protocol | CDP | Chrome DevTools Protocol |
| Runtime | Node.js/TypeScript | For any helper scripts |
| Browser | Chrome | Real browser with persistent profile |

### Dependencies

| Dependency | Purpose | Notes |
|------------|---------|-------|
| BrowserMCP | Browser control via MCP | `npx @browsermcp/mcp` |
| Chrome | Real browser session | User's logged-in profile |
| MCP Client | Claude Code MCP integration | Configured in Claude settings |

### BrowserMCP Capabilities (Assumed)

Based on typical BrowserMCP functionality:

| Capability | MCP Tool | Purpose |
|------------|----------|---------|
| Navigate | `browser_navigate` | Go to URL |
| Screenshot | `browser_screenshot` | Capture current page |
| Click | `browser_click` | Click element by selector/text |
| Type | `browser_type` | Enter text into field |
| DOM Snapshot | `browser_snapshot` | Get page structure |
| Evaluate | `browser_evaluate` | Run JS in page context |
| Console | `browser_console` | Get console logs |

**Note**: Exact tool names may vary. Claude Code will discover actual capabilities on first connection.

---

## 3. Constitution Check

### Principle Validation

| Principle | Status | Notes |
|-----------|--------|-------|
| Library-First | Pass | Using BrowserMCP (existing MCP server), not building from scratch |
| Test-First | Pass | Harness captures state for validation; each step verifiable |
| Simplicity | Pass | No orchestration layer - Claude Code calls MCP tools directly |
| Integration-First | Pass | Real browser, real site, real data from first step |

### Complexity Justification

| Decision | Justification | Simpler Alternative Considered |
|----------|---------------|--------------------------------|
| Artifact persistence | Enables autonomous debugging without human relay | Manual screenshot sharing - rejected (breaks autonomy) |
| State capture after every step | Turns failures into reproducible evidence | Capture only on error - rejected (insufficient context) |

---

## 4. Project Structure

### Documentation Tree

```
Sprints/Specs/002-browsermcp-cart-merge/
├── spec.md              # Feature specification
├── plan.md              # This implementation plan
├── tasks.md             # Generated task list (after /speckit-tasks)
└── checklists/
    ├── requirements.md  # Requirements validation
    └── design.md        # Design validation
```

### Runtime Artifacts Structure

```
runs/
└── {timestamp}/
    └── {step_name}/
        ├── screenshot.png     # Page screenshot
        ├── snapshot.json      # DOM/accessibility snapshot
        ├── url.txt            # Current URL
        ├── console.json       # Console logs
        └── notes.md           # Claude's observations
```

### Source Code Structure (Minimal)

```
automation/
├── harness/
│   └── capture-state.ts    # State capture utility (optional helper)
├── policies/
│   └── blocked-actions.ts  # Checkout button blocklist
└── artifacts/
    └── review-pack.ts      # Cart diff report generator
```

**Note**: Most "code" is Claude Code's direct MCP tool usage. Helper scripts are optional quality-of-life utilities.

---

## 5. Implementation Phases

### Phase 0: Setup (One-Time)

**Objective**: Establish BrowserMCP connection and prepare Chrome profile

**Steps**:
1. Install BrowserMCP Chrome extension
2. Configure MCP server in Claude Code settings:
   ```json
   {
     "mcpServers": {
       "browsermcp": { "command": "npx", "args": ["@browsermcp/mcp"] }
     }
   }
   ```
3. Create dedicated Chrome profile for automation (minimal extensions, auchan.pt login only)
4. Open auchan.pt in that profile and connect extension to tab
5. Verify Claude Code can access BrowserMCP tools

**Validation**: Claude Code can call `browser_screenshot` and receive image

---

### Phase 1: Exploration Harness

**Objective**: Build the state capture pattern that enables autonomous debugging

**FR Coverage**: FR003, FR004, FR009

**Deliverables**:

1. **capture_state() pattern**: After every significant action, capture:
   - Screenshot
   - DOM/accessibility snapshot
   - Current URL
   - Console logs (if available)

2. **Artifact persistence**: Save captures to `runs/{timestamp}/{step}/`

3. **Verification pattern**: Claude Code reads artifacts to verify state without human relay

**Implementation Notes**:
- This is a **pattern**, not necessarily code - Claude Code can call MCP tools directly
- Optional: Create a simple wrapper script if repetitive

**Validation**: Claude Code can navigate to a page, capture state, and describe what it sees from the artifacts

---

### Phase 2: Cart Merge Workflow

**Objective**: Implement the core user story - load last 3 orders into cart

**FR Coverage**: FR001, FR002, FR005, FR006, FR007, FR010
**BR Coverage**: BR001, BR002, BR005, BR006

**Workflow Steps**:

```
1. Verify Authentication
   - Check if auchan.pt shows logged-in state
   - If not logged in → STOP, request human re-login
   - capture_state("auth-check")

2. Navigate to Order History
   - Prefer URL navigation if known (e.g., /account/orders)
   - Else discover via menu/links
   - capture_state("order-history")

3. Identify Last 3 Orders
   - Extract order list from page
   - Select most recent 3 by date
   - capture_state("orders-identified")

4. Merge Each Order (loop)
   For each order (oldest first):
   - Click "reorder" or "add to cart" button
   - Handle platform merge prompt (BR006)
   - Verify items added
   - capture_state("merge-order-{n}")

5. Verify Final Cart State
   - Navigate to cart page
   - Extract cart contents
   - Compare to expected items
   - capture_state("final-cart")

6. Generate Report (FR010)
   - Natural language summary:
     - Orders found: N
     - Orders merged: M
     - Items in cart: X
     - Unavailable items: [list]
     - Confidence: high/medium/low
```

**URL-First Strategy** (from GPT-5.2 plan):
- Search via query parameters where possible
- Orders via known account URLs
- Use DOM inspection only when URLs insufficient

**Validation**: Starting from logged-in auchan.pt, agent merges 3 orders and reports cart state with confidence

---

### Phase 3: Safety Guardrails

**Objective**: Ensure agent NEVER proceeds to checkout

**BR Coverage**: BR001, BR003

**Deliverables**:

1. **Red Button Detector**: Block clicks on elements matching:
   - Text: "confirm", "place order", "pay", "checkout", "finalizar", "confirmar"
   - Aria labels matching above patterns
   - Known checkout button selectors

2. **Review Pack Generation**:
   - Cart diff (added/removed/substituted)
   - Total estimated cost
   - Screenshots of final cart
   - Timeline of actions ("what the agent clicked")

3. **Hard Stop Behavior**:
   - Agent explicitly states "Stopping before checkout. Please review cart."
   - Never attempts to proceed past cart review page

**Validation**: Agent refuses to click checkout button even if instructed

---

## 6. Navigation Strategy

### Known URLs (To Be Discovered)

| Page | URL Pattern | Discovery Method |
|------|-------------|------------------|
| Order History | `/conta/encomendas` or similar | Navigate via account menu |
| Order Detail | `/conta/encomendas/{id}` | Extract from order history |
| Cart | `/carrinho` or similar | Click cart icon |
| Search | `/pesquisa?q={query}` | URL parameter |

**Note**: Agent will discover and document actual URLs during first run.

### Selector Strategy

- **Prefer**: Text content, aria-labels, roles (stable across UI changes)
- **Avoid**: CSS classes, positional selectors (brittle)
- **Document**: Every selector used, for future reference

---

## 7. Error Handling Strategy

### Intelligent State Verification (FR008)

Instead of mechanical retries, agent:

1. **After each action**: Verify expected state achieved
2. **If unexpected**: Inspect DOM/console to understand why
3. **Diagnose**:
   - Network issue? (check console for errors)
   - Wrong element? (check what was clicked)
   - Page changed? (compare before/after snapshots)
4. **Decide**: Retry with adjustment, try alternative, or escalate

### Recoverable vs Unrecoverable

| Situation | Classification | Action |
|-----------|---------------|--------|
| Element not found | Recoverable | Try alternative selector, scroll, wait |
| Network timeout | Recoverable | Wait and retry navigation |
| Unexpected modal | Recoverable | Dismiss and continue |
| Login required | Unrecoverable | Stop, request human |
| Site error page | Unrecoverable | Stop, capture state, report |
| Unknown page state | Unrecoverable | Stop, capture state, report |

---

## 8. Sprint Task Mapping

### Single Sprint Breakdown

| Phase | Tasks | Points | Parallelizable |
|-------|-------|--------|----------------|
| Phase 0: Setup | T001-T003 | 3 | No (sequential) |
| Phase 1: Harness | T004-T006 | 5 | Partial |
| Phase 2: Workflow | T007-T012 | 8 | No (sequential) |
| Phase 3: Guardrails | T013-T015 | 5 | Partial |
| **Total** | **15 tasks** | **21** | |

### Task Flow

```
Phase 0: Setup
├── T001: Install BrowserMCP extension
├── T002: Configure MCP server in Claude settings
└── T003: Verify BrowserMCP connection

Phase 1: Harness
├── T004: Implement capture_state pattern
├── T005: Create artifact persistence (runs/ structure)
└── T006: Verify state capture end-to-end

Phase 2: Workflow
├── T007: Implement auth verification
├── T008: Navigate to order history (discover URL)
├── T009: Extract and identify last 3 orders
├── T010: Implement order merge loop
├── T011: Verify cart state after merge
└── T012: Generate natural language report

Phase 3: Guardrails
├── T013: Implement checkout button blocker
├── T014: Generate Review Pack
└── T015: End-to-end validation
```

---

## 9. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| BrowserMCP lacks needed capability | Medium | High | Document gaps; fall back to Playwright MCP |
| auchan.pt UI changes mid-sprint | Low | Medium | Agent adapts; document new selectors |
| Session expires frequently | Medium | Low | Agent detects and stops cleanly |
| Site blocks automation | Low | High | Use human-like delays; dedicated profile |
| Merge behavior differs from expected | Medium | Medium | Agent follows platform prompts (BR006) |

### Fallback Plan (from GPT-5.2)

If BrowserMCP hits limitations:
- Keep same workflow, swap control layer to:
  - **Playwright MCP** for deterministic runs, plus
  - **Chrome DevTools MCP** for live debug sessions
- Maintain same artifact format for consistency

---

## 10. Success Criteria

### Phase Completion Gates

| Phase | Gate Criteria |
|-------|--------------|
| Phase 0 | Claude Code can call BrowserMCP tools |
| Phase 1 | State capture produces viewable artifacts |
| Phase 2 | Cart contains items from 3 orders |
| Phase 3 | Agent refuses checkout; Review Pack generated |

### Definition of Done

- Claude Code can autonomously:
  - Explore auchan.pt without hardcoded paths
  - Load and merge last 3 orders
  - Produce cart diff with confidence
  - Iterate without human relay
- Browser remains usable and trustworthy for humans
- Agent NEVER clicks checkout confirmation

---

## 11. Implementation Notes

### Operating Mode (from GPT-5.2)

**During development**:
- Run in dedicated Chrome profile with tab connected
- Claude Code iterates by reading run artifacts
- Human only logs in once and leaves browser running

**In "away mode"**:
- Keep remote desktop session to Chrome profile (or small always-on machine)
- Claude Code runs workflow autonomously
- Always stops before final confirmation

### Observability Streams (from GPT-5.2)

| Stream | Purpose | Format |
|--------|---------|--------|
| `runs/` artifacts | Detailed state for Claude debugging | Screenshots, JSON, markdown |
| Agent output | Narrative for user trust | Natural language summary |

---

<!-- SPECKIT METADATA - DO NOT EDIT BELOW -->
```yaml
speckit:
  version: "1.0"
  template: "plan-template"
  source_spec: "002-browsermcp-cart-merge/spec.md"
  phases:
    - name: setup
      tasks: 3
      points: 3
    - name: harness
      tasks: 3
      points: 5
    - name: workflow
      tasks: 6
      points: 8
    - name: guardrails
      tasks: 3
      points: 5
  total_tasks: 15
  total_points: 21
  sprint_count: 1
  sprint_ready: true
```
