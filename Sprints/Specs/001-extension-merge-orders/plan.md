# Implementation Plan: Extension Button - Merge Last 3 Orders

<!--
  Generated by /speckit-plan
  Template: plan-template.md
  Sprint Integration: This plan drives task generation for sprints
-->

| Field | Value |
|-------|-------|
| Feature Branch | `feature/001-extension-merge-orders` |
| Created | 2026-01-17 |
| Source Spec | [spec.md](spec.md) |
| Target Sprint(s) | Sprint-EXT-I-002 |

---

## 1. Summary

**Primary Requirement**: Enable users to populate their Auchan.pt cart with items from their 3 most recent orders via a single button click in the Chrome extension popup.

**Technical Approach**: Leverage existing extension infrastructure (state machine, orchestrator, extractors) and add UI layer for merge button, progress display, and results. Modify cart phase to handle multi-order sequential merge with correct modes (replace first, merge subsequent).

**Sprint Scope**:
- Sprint EXT-I-002: Full feature implementation (merge button, progress, results, error handling)

**Effort Revised**: 13 points (reduced from original 21 - removed login detection, leveraging existing infrastructure)

---

## 2. Technical Context

### Project Classification
| Aspect | Value |
|--------|-------|
| Project Type | Enhancement (to existing extension) |
| Complexity | Low-Medium |
| Risk Level | Low |

### Technology Stack
| Layer | Technology | Version |
|-------|------------|---------|
| Language | TypeScript | 5.x |
| Extension | Chrome Manifest V3 | V3 |
| Build | esbuild | 0.19+ |
| Testing | Vitest | 1.x |
| State | chrome.storage.session | N/A |

### Dependencies (Existing - No New Dependencies)
| Dependency | Purpose | Status |
|------------|---------|--------|
| Chrome APIs | Storage, Messaging, Tabs, Alarms | Already wrapped in adapters |
| Anthropic SDK | LLM (optional) | Already integrated |
| Zod | Schema validation | Already in project |

---

## 3. Constitution Check

> Validate against project principles before proceeding.

### Phase -1 Gate (Pre-Research)

| Principle | Status | Notes |
|-----------|--------|-------|
| Library-First | [x] Pass | Reusing existing infrastructure, no new libraries |
| Test-First | [x] Pass | Unit tests for new logic, FakeAdapters for testing |
| Simplicity | [x] Pass | Minimal new code, leveraging existing orchestrator |
| Integration-First | [x] Pass | Content scripts tested against real Auchan.pt patterns |

### Complexity Justification

| Decision | Justification | Simpler Alternative Considered |
|----------|---------------|--------------------------------|
| Multi-order loop in orchestrator | Required by spec (3 orders) | Single order (rejected - doesn't meet requirements) |
| Real-time progress in popup | UX requirement (US2) | Polling (rejected - poor UX, more complexity) |

---

## 4. Project Structure

### Documentation Tree
```
Sprints/Specs/001-extension-merge-orders/
├── spec.md              # Feature specification ✓
├── plan.md              # This implementation plan ✓
├── research.md          # Technical research findings ✓
├── tasks.md             # Generated task list (next step)
└── checklists/
    ├── requirements.md  # Requirements validation ✓
    └── design.md        # Design validation (this step)
```

### Source Code Changes
```
extension/
├── manifest.json                    # ADD - Extension manifest (required)
├── esbuild.config.js               # ADD - Build configuration
├── popup/
│   ├── popup.html                  # MODIFY - Add merge button, progress, results
│   └── popup.js                    # MODIFY - Wire up merge flow
├── src/
│   ├── core/
│   │   └── orchestrator/
│   │       └── phases/
│   │           └── cart-phase.ts   # MODIFY - Multi-order merge logic
│   └── entry/
│       └── service-worker.ts       # MINOR - Verify message handlers
└── __tests__/
    └── integration/
        └── merge-orders.test.ts    # ADD - Integration test for merge flow
```

---

## 5. Data Model

### Entities (Already Defined in Spec)

All entities exist in the specification and are already implemented in extension types:

| Entity | Status | Location |
|--------|--------|----------|
| OrderSummary | Exists | `extension/src/types/orders.ts` |
| CartItem | Exists | `extension/src/types/cart.ts` |
| CartSnapshot | Exists | `extension/src/types/cart.ts` |
| CartDiff | Exists | `extension/src/core/cart/diff.ts` |
| RunState | Exists | `extension/src/types/state.ts` |

### No New Entities Required

The spec entities map directly to existing types. No database or new data structures needed.

---

## 6. API Contracts

### Message Protocol (Internal - Already Defined)

No external API. Extension uses internal message protocol between popup, service worker, and content scripts.

| Message | Sender | Receiver | Payload |
|---------|--------|----------|---------|
| `run.start` | Popup | Service Worker | `{}` (auto-selects 3 orders) |
| `run.cancel` | Popup | Service Worker | `{}` |
| `state.get` | Popup | Service Worker | `{}` |
| `state.update` | Service Worker | Popup (broadcast) | `{ state: RunState }` |
| `login.check` | Service Worker | Content Script | `{}` |

All messages already defined in `extension/src/types/messages.ts`.

---

## 7. Research Findings Summary

> Full details in [research.md](research.md)

### Key Finding: 90% Infrastructure Complete

| Component | Status | Reuse? |
|-----------|--------|--------|
| State Machine | Complete | Yes |
| Orchestrator | Complete | Modify cart phase |
| Content Scripts | Complete | Yes |
| Adapters (5) | Complete | Yes |
| Cart Diff | Complete | Yes |
| Popup UI | Partial | Enhance |

### Technical Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Results display | Popup (not side panel) | Simpler, sufficient for MVP |
| Order selection | Auto-select latest 3 | Per spec, simplifies UX |
| Build system | esbuild | Already in devDependencies |

---

## 8. Sprint Task Mapping

> Maps implementation plan to sprint structure.

### User Story → Task Mapping

| User Story | Priority | Points (Revised) | Phase |
|------------|----------|------------------|-------|
| US1: Merge Button & Trigger | P1 | 5 | Core |
| US2: Progress Feedback | P1 | 2 | Core |
| US3: Results Display | P1 | 1 | Core |
| US4: Error Handling | P2 | 3 | Polish |
| Integration Testing | - | 2 | Polish |
| **Total** | | **13** | |

**Note**: US5 (Login Detection) removed - extension assumes user is on Auchan.pt and logged in.

### Phase Breakdown

| Phase | Tasks | Description | Dependencies |
|-------|-------|-------------|--------------|
| **Setup** | T001-T002 | Build config, manifest (DONE) | None |
| **Core** | T003-T008 | Multi-order flow, progress, results | Setup |
| **Polish** | T009-T010 | Error handling, tests | Core |

### Parallel Execution Opportunities

```
Phase: Setup (DONE)
├── [P] T001: Create manifest.json ✓
└── [P] T002: Create esbuild config ✓

Phase: Core
├── T003: Write merge flow test (sequential - test first)
├── T004: Modify cart phase for multi-order (after T003)
├── T005: Add merge button ✓
├── [P] T006: Progress display in popup (after T004)
├── [P] T007: State update subscriptions (after T004)
└── [P] T008: Results display component (after T004)

Phase: Polish
├── T009: Error message display
└── T010: Manual testing & fixes (after all above)
```

---

## 9. Implementation Details

### T001: Create manifest.json

```json
{
  "manifest_version": 3,
  "name": "AI Shopping Copilot",
  "version": "0.1.0",
  "description": "Automate Auchan.pt cart building from order history",
  "permissions": ["storage", "activeTab", "alarms"],
  "host_permissions": ["https://*.auchan.pt/*"],
  "background": {
    "service_worker": "dist/service-worker.js",
    "type": "module"
  },
  "content_scripts": [{
    "matches": ["https://*.auchan.pt/*"],
    "js": ["dist/content-script.js"],
    "run_at": "document_idle"
  }],
  "action": {
    "default_popup": "popup/popup.html",
    "default_icon": { "16": "icons/icon16.png", "48": "icons/icon48.png" }
  }
}
```

### T005: Multi-Order Cart Phase Logic

```typescript
// Pseudocode for modified cart phase
async executeCartPhase(context: PhaseContext): Promise<void> {
  // 1. Navigate to order history
  await this.navigateToOrderHistory();
  this.updateProgress('Loading orders...', 1, 5);

  // 2. Extract last 3 orders
  const orders = await this.extractOrderHistory(3);
  if (orders.length === 0) {
    throw new PhaseError('NO_ORDERS', 'No orders found in history');
  }

  // 3. Sort oldest first for correct merge order
  const sortedOrders = orders.sort((a, b) =>
    new Date(a.date).getTime() - new Date(b.date).getTime()
  );

  // 4. Merge each order
  for (let i = 0; i < sortedOrders.length; i++) {
    const order = sortedOrders[i];
    const mode = i === 0 ? 'replace' : 'merge';

    this.updateProgress(
      `Merging order ${i + 1}/${sortedOrders.length}...`,
      2 + i,
      5
    );

    await this.reorderOrder(order.orderId, order.detailUrl, mode);
  }

  // 5. Scan final cart
  this.updateProgress('Scanning cart...', 5, 5);
  const cartSnapshot = await this.scanCart();

  // 6. Compute diff (vs empty cart since first order was 'replace')
  context.cartSnapshot = cartSnapshot;
  context.cartDiff = calculateCartDiff([], cartSnapshot.items);
}
```

### Popup UI Structure

```html
<!-- popup.html simplified (no login detection) -->
<div id="merge-section" class="section">
  <h2>Quick Cart Builder</h2>

  <!-- Merge button (US1) - always enabled -->
  <button id="merge-btn" class="primary-btn">
    Merge last 3 orders
  </button>
  <p class="hint">Populates cart with your recent purchases</p>

  <!-- Progress section (US2) - shown during operation -->
  <div id="progress-section" class="hidden">
    <div class="progress-bar">
      <div class="progress-fill" style="width: 0%"></div>
    </div>
    <p id="progress-text">Starting...</p>
    <button id="cancel-btn" class="secondary-btn">Cancel</button>
  </div>

  <!-- Results section (US3) -->
  <div id="results-section" class="hidden">
    <h3>Merge Complete</h3>
    <div class="stats">
      <div class="stat">
        <span class="value" id="added-count">0</span>
        <span class="label">Items Added</span>
      </div>
      <div class="stat">
        <span class="value" id="total-price">€0.00</span>
        <span class="label">Cart Total</span>
      </div>
    </div>
    <div id="unavailable-items" class="hidden">
      <p class="warning">Some items unavailable</p>
    </div>
    <a href="https://www.auchan.pt/pt/carrinho-compras"
       target="_blank" class="primary-btn">
      View Cart
    </a>
  </div>

  <!-- Error section (US4) -->
  <div id="error-section" class="hidden">
    <p class="error-text" id="error-message"></p>
    <button id="retry-btn" class="secondary-btn">Retry</button>
  </div>
</div>
```

**Note**: Login detection removed. Extension checks if on auchan.pt domain and shows error if not.

---

## 10. Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Auchan.pt DOM changes | Medium | High | Selector registry with fallbacks already in place |
| Reorder modal timing | Low | Medium | Wait for modal, multiple selector patterns |
| Build configuration issues | Low | Low | Reference existing extension builds |
| User closes popup during run | Low | Low | Operation continues in service worker |
| 3 orders causes timeout | Low | Medium | Progress feedback keeps user informed |

---

## 11. Implementation Checklist

> Design validation for plan.md

- [x] CHK001: All user stories mapped to tasks
- [x] CHK002: Data model complete (using existing entities)
- [x] CHK003: API contracts defined (internal messages)
- [x] CHK004: Test strategy documented
- [x] CHK005: Sprint allocation validated (single sprint)
- [x] CHK006: Dependencies identified (all existing)
- [x] CHK007: Constitution check passed
- [x] CHK008: Safety constraint preserved (no checkout)

---

## 12. Next Steps

1. **Run `/speckit-tasks 001-extension-merge-orders`** to generate detailed task breakdown
2. **Create Sprint-EXT-I-002** for implementation
3. **Execute setup phase** (manifest.json, build config)
4. **Implement core flow** (multi-order merge)
5. **Add UI components** (progress, results)
6. **Test and iterate**

---

<!-- SPECKIT METADATA - DO NOT EDIT BELOW -->
```yaml
speckit:
  version: "1.0"
  template: "plan-template"
  source_spec: "001-extension-merge-orders/spec.md"
  phases:
    - name: setup
      tasks: 2
      status: done
    - name: core
      tasks: 6
    - name: polish
      tasks: 2
  total_tasks: 10
  total_points: 13
  sprint_allocation: 1
  sprint_id: "Sprint-EXT-I-002"
  sprint_ready: true
  constitution_check:
    library_first: pass
    test_first: pass
    simplicity: pass
    integration_first: pass
  safety_verified: true
  simplification_note: "US5 (Login Detection) removed - assumes user on Auchan.pt"
```
