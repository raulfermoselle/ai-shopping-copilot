# Research: Extension Button - Merge Last 3 Orders

<!--
  Generated by /speckit-plan
  Technical investigation for implementation planning
-->

| Field | Value |
|-------|-------|
| Created | 2026-01-17 |
| Feature | 001-extension-merge-orders |

---

## Executive Summary

The Chrome extension infrastructure is **~90% complete**. Most of the heavy lifting (state machine, orchestrator, adapters, extractors) is already implemented. This feature primarily requires **UI enhancements** and **workflow adjustments** rather than core infrastructure work.

---

## 1. Existing Infrastructure Analysis

### Component Status Overview

| Component | Status | Lines | Notes |
|-----------|--------|-------|-------|
| State Machine | **Complete** | ~300 | All states/phases, guards, persistence |
| Orchestrator | **Complete** | 1,151 | Full phase execution engine |
| Service Worker | **Complete** | 788 | Bootstrap, routing, recovery |
| Content Script | **Complete** | ~400 | All 4 extractors working |
| Chrome Adapters | **Complete** | 5 adapters | Storage, Messaging, Tabs, Alarms, LLM |
| Fake Adapters | **Complete** | 5 adapters | For unit testing |
| Cart Diff Logic | **Complete** | ~200 | All comparison functions |
| Slot Scoring | **Complete** | ~150 | Day/time/fee scoring |
| Popup UI | **Partial** | ~150 | Basic layout, needs merge button |
| Message Protocol | **Complete** | ~300 | All action types defined |

### What Exists (Reusable)

1. **Order History Extraction** - `extractOrderHistory(limit?)` extracts up to 10 orders
2. **Reorder Flow** - `reorderOrder(orderId, mode)` handles Auchan.pt reorder with modal detection
3. **Cart Scanning** - `extractCartItems()` bulk extracts all cart items
4. **Cart Diff** - `calculateCartDiff()`, `hasChanges()`, `generateDiffSummary()`
5. **State Machine** - Transitions: `idle → running → (cart → substitution → slots → finalizing) → review → complete`
6. **Progress Tracking** - State includes `phase`, `progress` message, `currentStep`
7. **Login Detection** - `detectLoginState()` with 3 selector fallbacks
8. **Recovery** - Service worker recovers state from `chrome.storage.session` on restart

### What's Missing (To Implement)

| Gap | Impact | Effort |
|-----|--------|--------|
| "Merge last 3 orders" button in popup | **Required** | Low |
| Progress display in popup (real-time) | **Required** | Medium |
| Results display in popup | **Required** | Medium |
| Merge mode orchestration (3 orders sequential) | **Required** | Medium |
| Cancel button functionality | **Required** | Low |
| Error message display | **Required** | Low |
| Build/bundle configuration | **Blocking** | Low |
| manifest.json in extension root | **Blocking** | Low |

---

## 2. Technical Decisions

### Decision 1: Popup vs Side Panel for Results

**Question**: Should merge results display in popup or a side panel?

**Options Considered**:

| Option | Pros | Cons |
|--------|------|------|
| **Popup (320px)** | Simple, already exists, quick to modify | Limited space for detailed results |
| **Side Panel** | More room, persistent while browsing | Chrome 114+ only, more complex, new component |

**Decision**: **Popup for MVP**

**Rationale**:
- Popup already has status display infrastructure
- Results summary fits in 320px (item counts, total price)
- Detailed item list can link to "View Cart" on Auchan.pt
- Side panel can be Phase 2 enhancement

---

### Decision 2: Order Selection vs Auto-Select Latest 3

**Question**: Should user select which orders to merge or auto-select latest 3?

**Decision**: **Auto-select latest 3** (per spec clarification)

**Rationale**:
- Simplifies MVP UX significantly
- No order selection UI needed in popup
- User can view order history on Auchan.pt if curious
- Consistent behavior every time

---

### Decision 3: Cart Phase Modification

**Question**: How to modify existing cart phase for multi-order merge?

**Current Flow** (single order):
```
1. Navigate to order history
2. Select single order (first in list)
3. Reorder with mode=replace
4. Scan cart
5. Compute diff
```

**New Flow** (merge 3):
```
1. Navigate to order history
2. Extract 3 most recent orders
3. Reorder oldest (mode=replace) - clears cart, starts fresh
4. Reorder middle (mode=merge) - adds to cart
5. Reorder newest (mode=merge) - adds to cart
6. Scan final cart
7. Compute diff vs empty cart (shows all added items)
```

**Decision**: Modify `executeCartPhase()` to loop over orders with correct modes

**Implementation Notes**:
- Loop variable controls mode: `i === 0 ? 'replace' : 'merge'`
- Progress updates after each order: "Merging order 1/3...", "Merging order 2/3..."
- Handle partial failure (if order 2 fails, still have order 1 items)

---

### Decision 4: Build System

**Question**: What build system for bundling extension?

**Options**:
| Option | Pros | Cons |
|--------|------|------|
| esbuild | Fast, simple config, already in devDependencies | Less plugin ecosystem |
| Vite | Hot reload, good DX | Overkill for extension |
| Rollup | Flexible, tree-shaking | More config needed |
| tsc only | No bundler, simple | No tree-shaking, larger output |

**Decision**: **esbuild** (already in project)

**Rationale**:
- Already in `devDependencies`
- Simple config for service worker + content script bundles
- Fast enough for development iteration

---

## 3. Architecture Alignment

### Hexagonal Architecture Compliance

The existing extension follows hexagonal architecture (ports & adapters). New code must:

1. **No Chrome imports in core/** - All new logic goes in `core/`, uses ports
2. **Adapters for Chrome APIs** - Already implemented, just use them
3. **Types in types/** - Message types, state types already defined

### Existing Patterns to Follow

```typescript
// Message handling pattern (service-worker.ts)
case 'run.start':
  await orchestrator.startRun(sender.tab?.id);
  sendResponse({ success: true });
  break;

// State update pattern (state-machine.ts)
const newState = this.transition(action);
await this.deps.storage.set({ runState: newState }, 'session');
this.notifySubscribers(newState);

// Progress update pattern (orchestrator.ts)
this.updateProgress('Loading order history...', 1, 5);
```

---

## 4. Selector Registry Usage

### Required Selectors (Already Exist)

| Page | Selector Key | Purpose |
|------|--------------|---------|
| login | `userNameElement` | Detect logged-in user |
| order-history | `orderCards` | List of orders |
| order-history | `orderReorderButton` | "Encomendar de novo" button |
| cart | `cartItems` | Product tiles in cart |
| cart | `cartTotal` | Total price display |

### No New Selectors Needed

All required selectors exist in `data/selectors/pages/`. The feature reuses existing extraction logic.

---

## 5. Message Protocol Extensions

### Existing Messages (Sufficient)

| Action | Direction | Purpose |
|--------|-----------|---------|
| `run.start` | Popup → SW | Start merge operation |
| `run.cancel` | Popup → SW | Cancel operation |
| `state.get` | Popup → SW | Get current state |
| `state.update` | SW → Popup | Broadcast state changes |
| `login.check` | SW → CS | Check login status |
| `order.extractHistory` | SW → CS | Get order list |
| `order.reorder` | SW → CS | Trigger reorder |
| `cart.scan` | SW → CS | Extract cart items |

### No New Messages Needed

The existing protocol covers all requirements. Just need to:
- Call `run.start` when merge button clicked
- Listen for `state.update` to refresh popup display

---

## 6. Risk Analysis

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Auchan.pt DOM changes | Medium | High | Selector registry with fallbacks (already implemented) |
| Reorder modal detection fails | Low | Medium | Multiple selector patterns for modal buttons |
| Service worker suspension | Medium | Low | State persistence + recovery already implemented |
| User closes tab during merge | Medium | Low | Pause state, prompt to reopen |
| 3 orders takes too long | Low | Medium | Progress feedback keeps user informed |

---

## 7. Test Strategy

### Unit Tests (Existing)

| Test File | Coverage |
|-----------|----------|
| `cart-scanner.test.ts` | Cart extraction |
| `order-history.test.ts` | Order extraction |
| `diff.test.ts` | Cart diff calculation |
| `slots-scoring.test.ts` | Slot scoring |

### New Tests Needed

| Test | Type | Priority |
|------|------|----------|
| Multi-order merge flow | Integration | P1 |
| Popup state updates | Unit | P1 |
| Cancel mid-operation | Integration | P2 |
| Error handling | Unit | P2 |

### Test Approach

Use FakeAdapters for unit tests:
```typescript
const deps = createTestDependencies();
const orchestrator = createOrchestrator(deps);

// Simulate 3 orders
deps.messaging.simulateContentScriptResponse('order.extractHistory', [
  { orderId: '001', date: '2026-01-10', detailUrl: '/order/001' },
  { orderId: '002', date: '2026-01-12', detailUrl: '/order/002' },
  { orderId: '003', date: '2026-01-15', detailUrl: '/order/003' },
]);

await orchestrator.startRun(1);
expect(deps.storage.get('runState').status).toBe('running');
```

---

## 8. Conclusions

### Implementation Feasibility: HIGH

The feature is well-positioned for implementation:
- 90% of infrastructure already exists
- No architectural changes needed
- Primarily UI work + minor orchestration tweaks
- Estimated effort reduction from 21 points to ~13 points

### Recommended Approach

1. **Phase 1: Popup UI** (US5, US1 partial) - 3 points
   - Add merge button with login-gated state
   - Wire up to `run.start` message

2. **Phase 2: Multi-Order Flow** (US1 complete) - 5 points
   - Modify `executeCartPhase()` for 3-order loop
   - Add mode switching (replace → merge → merge)

3. **Phase 3: Progress Display** (US2) - 3 points
   - Subscribe to `state.update` in popup
   - Render phase/progress in UI

4. **Phase 4: Results Display** (US3) - 2 points
   - Show diff summary on completion
   - "View Cart" button to Auchan.pt cart page

5. **Phase 5: Error Handling** (US4) - 2 points
   - Map error types to user messages
   - Add retry button
   - Add cancel functionality

**Revised Total: ~15 points** (down from 21, due to existing infrastructure)

---

<!-- SPECKIT METADATA - DO NOT EDIT BELOW -->
```yaml
speckit:
  version: "1.0"
  type: "research"
  feature_id: "001-extension-merge-orders"
  findings:
    infrastructure_complete_pct: 90
    new_code_needed: "popup-ui, multi-order-flow"
    existing_code_reused: "state-machine, orchestrator, extractors, adapters, diff-logic"
    effort_reduction: "21 → 15 points"
  decisions:
    - topic: "results-display"
      choice: "popup"
      rationale: "simpler, exists, sufficient for MVP"
    - topic: "order-selection"
      choice: "auto-select-latest-3"
      rationale: "per spec, simplifies UX"
    - topic: "build-system"
      choice: "esbuild"
      rationale: "already in devDependencies, fast"
```
