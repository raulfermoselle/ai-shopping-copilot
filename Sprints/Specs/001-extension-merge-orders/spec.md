# Feature Specification: Extension Button - Merge Last 3 Orders

<!--
  Generated by /speckit-specify
  Template: spec-template.md
  Sprint Integration: This specification drives sprint task generation
-->

| Field | Value |
|-------|-------|
| Feature Branch | `feature/001-extension-merge-orders` |
| Created | 2026-01-17 |
| Status | Draft |
| Target Sprint | Sprint-EXT-I-001 |

---

## 1. User Stories & Journeys

> Each user story MUST be independently testable to ensure viable MVP development.

### Story Priority Levels
- **P1**: Core functionality - Required for MVP
- **P2**: Enhanced functionality - Improves user experience
- **P3**: Nice-to-have - Future enhancement

---

### User Story: [US1] Trigger Order Merge from Extension Popup

**Priority**: P1

**As an** Auchan.pt user with the Chrome extension installed
**I want** to click a "Merge last 3 orders" button in the extension popup
**So that** my cart is populated with items from my 3 most recent orders without manual work

**Why this priority?**: This is the core value proposition of the extension - saving time on repetitive cart building. Without this, the extension provides no utility.

**Precondition**: User is on any auchan.pt page and logged in. The extension assumes this is true and does not verify login state.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Happy path | User is on Auchan.pt | User clicks "Merge last 3 orders" button | Extension initiates merge workflow, navigates to order history, and begins merge |
| No orders available | User has no order history | User clicks "Merge last 3 orders" | Shows error: "No orders found in history" |
| Fewer than 3 orders | User has only 1-2 orders in history | User clicks "Merge last 3 orders" | Extension merges all available orders (1 or 2), shows info message about available count |
| Not on Auchan.pt | User is not on an auchan.pt page | User clicks "Merge last 3 orders" | Shows error: "Please open Auchan.pt first" |

**Independent Testing Approach**:
- Can be developed without: Backend Coordinator agent, LLM integration, preferences system
- Requires: Chrome extension infrastructure (adapters), content scripts for DOM extraction
- Test data: Mock order history data, mock cart state

---

### User Story: [US2] Visual Progress Feedback During Merge

**Priority**: P1

**As a** user who triggered the merge operation
**I want** to see visual feedback of what the extension is doing
**So that** I know the operation is progressing and can anticipate completion

**Why this priority?**: The merge operation takes several seconds. Without feedback, users will think the extension is broken or frozen.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Progress display | Merge operation is in progress | During execution | Popup shows: "Loading orders... (1/3)" → "Merging order 1... (2/3)" → "Merging order 2... (3/3)" → etc. |
| Phase transitions | Moving from one phase to another | Phase completes | Progress text updates immediately, progress indicator advances |
| Long operation | Merge is taking longer than expected | After 30 seconds | Show reassurance message: "Still working..." |
| Tab closed during operation | User closes the Auchan.pt tab during merge | Tab closes | Operation pauses, popup shows: "Auchan.pt tab required - please reopen" |

**Independent Testing Approach**:
- Can be developed without: Actual cart modifications on Auchan.pt
- Requires: State machine transitions, service worker ↔ popup communication
- Test data: Simulated state transitions with FakeAdapter

---

### User Story: [US3] View Merge Results

**Priority**: P1

**As a** user who completed the merge operation
**I want** to see a summary of what items were added to my cart
**So that** I can verify the merge worked correctly before proceeding

**Why this priority?**: Without seeing results, users cannot verify the operation succeeded and must manually navigate to the cart to check.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Successful merge | Merge completed successfully | Operation finishes | Popup shows: "Added X items to cart" with total price, "View Cart" button |
| Partial success | Some items were unavailable | Operation finishes | Popup shows: "Added X items (Y unavailable)" with list of unavailable items |
| Items already in cart | Cart had items before merge | Operation finishes | Show diff: "Added X new, updated Y quantities, Z unchanged" |
| Complete failure | Merge failed entirely | Operation fails | Show error message with retry option |

**Independent Testing Approach**:
- Can be developed without: Actual cart page
- Requires: Cart diff calculation logic, result rendering in popup
- Test data: Mock CartSnapshot before/after data

---

### User Story: [US4] Handle Errors Gracefully

**Priority**: P2

**As a** user experiencing issues during merge
**I want** clear error messages and recovery options
**So that** I can understand what went wrong and how to fix it

**Why this priority?**: Error handling improves user experience but isn't blocking for the happy path. Initial users can retry manually if issues occur.

**Acceptance Scenarios**:

| Scenario | Given | When | Then |
|----------|-------|------|------|
| Session expired | User's Auchan session times out mid-operation | Session expires | Popup shows: "Session expired - please log in again", operation pauses |
| Network error | Connection to Auchan.pt fails | Network error occurs | Popup shows: "Network error - retrying..." with auto-retry |
| DOM structure changed | Auchan.pt updated their page layout | Selectors fail | Popup shows: "Unable to read page - please report issue" |
| Operation cancelled | User clicks Cancel during merge | Cancel clicked | Operation stops immediately, show: "Merge cancelled" |

**Independent Testing Approach**:
- Can be developed without: Actual Auchan.pt page
- Requires: Error classification system, retry logic
- Test data: Simulated error conditions in FakeAdapters

---

## 2. Functional Requirements

> Focus on WHAT the system must do, not HOW it will be implemented.

### Core Capabilities

| ID | Requirement | User Story | Testable Criteria |
|----|-------------|------------|-------------------|
| FR001 | Extension popup displays a "Merge last 3 orders" button | US1 | Button visible in popup |
| FR002 | Clicking button initiates order merge workflow | US1 | State machine transitions from `idle` to `running` |
| FR003 | Extension navigates to order history page | US1 | Navigates to historico-encomendas URL |
| FR004 | Extension loads order history from Auchan.pt | US1 | Retrieves at minimum: orderId, date, detailUrl for 3 recent orders |
| FR005 | Extension executes reorder for each order | US1 | Calls reorder flow in sequence: oldest first, mode=replace then mode=merge |
| FR006 | Extension captures cart state before and after merge | US1, US3 | CartSnapshot recorded at start and end of operation |
| FR007 | Extension calculates diff between original and final cart | US3 | CartDiff shows added/removed/changed items |
| FR008 | Popup displays operation progress in real-time | US2 | Progress text updates within 500ms of state change |
| FR009 | Popup displays final results with item counts and totals | US3 | Shows added count, unavailable count, total price |
| FR010 | Extension handles errors with user-friendly messages | US4 | No raw technical errors shown to user |
| FR011 | User can cancel operation at any time | US4 | Cancel stops operation within 2 seconds |

### Business Rules

| ID | Rule | Applies To | Exception |
|----|------|------------|-----------|
| BR001 | Orders are merged oldest-to-newest | FR005 | If only 1 order, use replace mode |
| BR002 | First order uses "replace" mode, subsequent use "merge" mode | FR005 | N/A |
| BR003 | Maximum 3 orders merged per operation | FR004 | If fewer than 3 exist, merge all available |
| BR004 | Operation state persists across service worker restarts | FR002-FR007 | User must restart if browser closes |
| BR005 | Extension NEVER initiates checkout or payment | ALL | Non-negotiable safety constraint |
| BR006 | Extension assumes user is logged in | ALL | Will fail gracefully if not logged in |

---

## 3. Key Entities

> Define data concepts without implementation details.

### Entity: OrderSummary

**Description**: A summary of a past order from order history page

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| orderId | Unique identifier for the order | Yes | Non-empty string |
| date | When the order was placed | Yes | Valid date/timestamp |
| productCount | Number of items in the order | No | Integer >= 0 |
| totalPrice | Order total in EUR | No | Number >= 0 |
| detailUrl | URL to view order details | Yes | Valid Auchan.pt URL |

**Relationships**:
- OrderSummary is extracted from order history page
- OrderSummary has link to order detail page (for reorder button)

---

### Entity: CartItem

**Description**: A single item in the shopping cart

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| productId | Unique product identifier | No | May be missing if not in DOM |
| name | Product display name | Yes | Non-empty string |
| quantity | Number of units | Yes | Integer > 0 |
| unitPrice | Price per unit in EUR | Yes | Number >= 0 |
| available | Whether item is in stock | Yes | Boolean |
| availabilityNote | Why item is unavailable | No | Present only if available=false |
| productUrl | Link to product page | No | Valid URL |

**Relationships**:
- CartItem belongs to CartSnapshot
- CartItem appears in CartDiff (added/removed/changed)

---

### Entity: CartSnapshot

**Description**: Complete state of the cart at a point in time

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| timestamp | When snapshot was taken | Yes | ISO timestamp |
| items | Array of cart items | Yes | Array of CartItem |
| itemCount | Total number of items | Yes | Integer >= 0 |
| totalPrice | Cart total in EUR | Yes | Number >= 0 |

**Relationships**:
- CartSnapshot contains many CartItems
- CartDiff compares two CartSnapshots

---

### Entity: CartDiff

**Description**: Difference between two cart states

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| added | Items in after-cart but not before-cart | Yes | Array of CartItem |
| removed | Items in before-cart but not after-cart | Yes | Array of CartItem |
| quantityChanged | Items with different quantities | Yes | Array with oldQty/newQty |
| unchanged | Items identical in both | Yes | Array of CartItem |
| priceDifference | Net change in cart total | Yes | Number (can be negative) |
| newTotalPrice | Final cart total | Yes | Number >= 0 |

---

### Entity: RunState

**Description**: Current state of the merge operation

**Attributes**:
| Attribute | Description | Required | Constraints |
|-----------|-------------|----------|-------------|
| status | Overall run status | Yes | idle / running / paused / complete / error |
| phase | Current phase within running | No | initializing / cart / finalizing |
| progress | Human-readable progress message | No | String for display |
| error | Error details if failed | No | Present only if status=error |
| startedAt | When run started | No | ISO timestamp |
| completedAt | When run finished | No | ISO timestamp |

**State Transitions**:
```
idle --[start]--> running --[complete]--> complete
                     |
                     +--[error]--> error
                     |
                     +--[cancel]--> idle
                     |
                     +--[pause]--> paused --[resume]--> running
```

---

## 4. Edge Cases & Error Scenarios

| Scenario | Trigger | Expected Behavior | User Story |
|----------|---------|-------------------|------------|
| Empty order history | User has never placed an order | Disable button, show "No orders available" | US1 |
| Single order | User has only 1 previous order | Merge that order using replace mode, show info message | US1 |
| Order reorder fails | Auchan.pt reorder button doesn't respond | Retry 2 times, then show error with manual fallback suggestion | US4 |
| Cart modal appears | Auchan shows "replace or merge" modal | Auto-select appropriate mode based on BR002 | US1 |
| Service worker restarts | Chrome suspends extension | Recover state from storage, continue operation | US2 |
| Popup closed during run | User closes popup while running | Operation continues, popup shows progress when reopened | US2 |
| Tab navigation during run | User navigates away from Auchan.pt | Pause operation, show "Return to Auchan.pt" message | US4 |
| Items went out of stock | Between order and reorder, item became unavailable | Include in "unavailable" count in results | US3 |
| Price changed | Item price different from original order | Show in cart but don't highlight (expected behavior) | US3 |

---

## 5. Success Criteria

> Technology-agnostic, measurable outcomes.

### User Metrics
| Metric | Target | Measurement Method |
|--------|--------|-------------------|
| Time to populate cart | < 60 seconds | Measure from button click to completion |
| User understands status | Clear at all times | No "what's happening?" questions in testing |
| Operation success rate | > 95% | Completed operations / attempted operations |

### System Performance
| Metric | Target | Acceptable Range |
|--------|--------|------------------|
| Login detection | < 1 second | 0-2 seconds |
| Progress update latency | < 500ms | 0-1 second |
| Full operation time | < 60 seconds | 30-120 seconds |

### Business Impact
| KPI | Baseline | Target | Timeframe |
|-----|----------|--------|-----------|
| Cart prep time | ~30 min manual | < 2 min | Per shopping session |
| Cart abandonment due to tedium | Unknown | Reduced | First month |

---

## 6. Out of Scope

> Explicitly list what is NOT included in this feature.

- **Stock pruning**: No removal of items based on household inventory (Phase 2)
- **Substitution suggestions**: No replacement recommendations for unavailable items (Phase 2)
- **Delivery slot selection**: Not part of this feature (separate SlotScout feature)
- **Checkout automation**: Extension never touches checkout/payment (safety constraint)
- **Order customization**: No quantity modifications during merge (manual adjustment later)
- **Favorites integration**: Only order history, not favorites list (Phase 2)
- **LLM-enhanced decisions**: Pure heuristics/automation, no AI reasoning (Phase 3)
- **Persistent preferences**: No "remember my choices" learning (Phase 3)

---

## 7. Clarifications

> Record all clarifications and decisions made during specification.

### 2026-01-17 - Initial Specification

- **Q**: Should we support selecting which orders to merge?
  **A**: No - always merge the 3 most recent. Simplifies UX for MVP.
  **Impact**: US1 simplified, no order selection UI needed.

- **Q**: What if the cart already has items before merge?
  **A**: First order replaces cart (clears existing), subsequent merge. User sees diff at end.
  **Impact**: BR001, BR002 defined.

- **Q**: Should errors be auto-retried?
  **A**: Yes, up to 2 retries for transient errors. Then show user error.
  **Impact**: US4 scenarios, error handling requirements.

---

## 8. Sprint Integration

> Maps this specification to sprint execution.

### Estimated Effort
| Component | Story Points | Sprint Capacity |
|-----------|-------------|-----------------|
| US1: Merge Button & Trigger | 5 | 30% |
| US2: Progress Feedback | 5 | 30% |
| US3: Results Display | 3 | 20% |
| US4: Error Handling | 3 | 15% |
| Integration Testing | 1 | 5% |
| **Total** | **17** | **~100%** |

### Sprint Allocation Recommendation
- **Single Sprint**: Total effort is approximately one sprint capacity
- **Dependencies**: Requires Chrome extension infrastructure from Sprint-EXT-I-001
  - If Sprint-EXT-I-001 not complete: Must complete adapters and state machine first
  - If Sprint-EXT-I-001 complete: Can implement feature directly

### Dependencies on Other Sprints
| Dependency | Sprint | Status |
|------------|--------|--------|
| Chrome adapters (storage, messaging, tabs) | Sprint-EXT-I-001 | In Progress |
| State machine implementation | Sprint-EXT-I-001 | In Progress |
| Content script extractors | Sprint-EXT-I-001 | In Progress |
| Cart diff logic | Sprint-EXT-I-001 | In Progress |

### Implementation Notes

**Existing Code to Leverage**:
- `extension/src/core/orchestrator/` - State machine and phases
- `extension/src/adapters/` - Chrome API adapters
- `extension/src/content-scripts/extractors/` - DOM extraction
- `extension/src/core/cart/diff.ts` - Cart comparison
- `src/agents/cart-builder/tools/` - Reorder tool patterns (to port)

**New Code Required**:
- Popup UI button and progress display
- CartPhase implementation for merge workflow
- Message handlers for merge operations
- Result display component

---

<!-- SPECKIT METADATA - DO NOT EDIT BELOW -->
```yaml
speckit:
  version: "1.0"
  template: "spec-template"
  feature_id: "001-extension-merge-orders"
  stories:
    - id: US1
      title: "Trigger Order Merge from Extension Popup"
      priority: P1
      status: draft
      points: 5
    - id: US2
      title: "Visual Progress Feedback During Merge"
      priority: P1
      status: draft
      points: 5
    - id: US3
      title: "View Merge Results"
      priority: P1
      status: draft
      points: 3
    - id: US4
      title: "Handle Errors Gracefully"
      priority: P2
      status: draft
      points: 3
  requirements_count: 11
  business_rules_count: 6
  clarifications_count: 3
  total_points: 17
  sprint_ready: false
```
