# Tasks: Extension Button - Merge Last 3 Orders

<!--
  Generated by /speckit-tasks
  Template: tasks-template.md
  Sprint Integration: Maps directly to SPRINT-PLAN.md tasks
-->

| Field | Value |
|-------|-------|
| Feature Branch | `feature/001-extension-merge-orders` |
| Generated | 2026-01-17 |
| Source Plan | [plan.md](plan.md) |
| Target Sprint(s) | Sprint-EXT-I-002 |
| Total Tasks | 10 |
| Total Points | 13 |

---

## Task Format

```
- [ ] [TaskID] [P] [Story] Description | file/path
```

- `[ ]` - Checkbox (mandatory)
- `[TaskID]` - T001, T002, etc.
- `[P]` - Parallelizable marker (only if task can run concurrently)
- `[Story]` - User story reference: [US1], [US2], etc. or [SETUP], [FOUNDATION], [POLISH]
- Description - Clear action with file path

---

## Phase 1: Setup (DONE)

> Build configuration and manifest. Must complete before extension can load in Chrome.

**Sprint Allocation**: Sprint-EXT-I-002 - Setup phase
**Points**: 1
**Status**: COMPLETE

- [x] T001 [P] [SETUP] Create Chrome extension manifest.json with MV3 configuration | extension/manifest.json
- [x] T002 [P] [SETUP] Create esbuild configuration for bundling service-worker and content-script | extension/build.mjs

**Phase 1 Complete Criteria**:
- [x] `npm run build` succeeds
- [x] Extension loads in Chrome without errors
- [x] Service worker registers correctly
- [x] Content script injects on auchan.pt pages

**Implementation Notes**:

**T001 - manifest.json**:
```json
{
  "manifest_version": 3,
  "name": "AI Shopping Copilot",
  "version": "0.1.0",
  "description": "Automate Auchan.pt cart building from order history",
  "permissions": ["storage", "activeTab", "alarms"],
  "host_permissions": ["https://*.auchan.pt/*"],
  "background": {
    "service_worker": "dist/service-worker.js",
    "type": "module"
  },
  "content_scripts": [{
    "matches": ["https://*.auchan.pt/*"],
    "js": ["dist/content-script.js"],
    "run_at": "document_idle"
  }],
  "action": {
    "default_popup": "popup/popup.html",
    "default_icon": { "16": "icons/icon16.png", "48": "icons/icon48.png", "128": "icons/icon128.png" }
  },
  "icons": { "16": "icons/icon16.png", "48": "icons/icon48.png", "128": "icons/icon128.png" }
}
```

**T002 - esbuild.config.js**:
```javascript
const esbuild = require('esbuild');

const common = {
  bundle: true,
  minify: process.env.NODE_ENV === 'production',
  sourcemap: process.env.NODE_ENV !== 'production',
  target: ['chrome100'],
};

// Build service worker
esbuild.build({
  ...common,
  entryPoints: ['src/entry/service-worker.ts'],
  outfile: 'dist/service-worker.js',
  format: 'esm',
});

// Build content script
esbuild.build({
  ...common,
  entryPoints: ['src/entry/content-script.ts'],
  outfile: 'dist/content-script.js',
  format: 'iife',
});
```

---

## Phase 2: Core (US1, US2, US3)

> Merge button, multi-order workflow, progress display, and results.

**Sprint Allocation**: Sprint-EXT-I-002 - Core phase
**Points**: 9 (US1: 5, US2: 2, US3: 1)

### US1: Merge Button & Multi-Order Flow

**Tests (Write FIRST)**

- [x] T003 [US1] Write integration test for multi-order merge flow using FakeAdapters | extension/src/core/orchestrator/__tests__/merge-orders.test.ts

**Implementation**

- [x] T004 [US1] Modify cart phase to loop through 3 orders with replace/merge modes | extension/src/core/orchestrator/orchestrator.ts
- [x] T005 [US1] Add merge button to popup | extension/popup/popup.html, extension/popup/popup.js

### US2: Progress Feedback

- [x] T006 [US2] Add progress section to popup (progress bar, step text, cancel button) | extension/popup/popup.html, extension/popup/popup.js
- [x] T007 [US2] Subscribe to state.update messages and refresh progress display | extension/popup/popup.js

### US3: Results Display

- [x] T008 [US3] Add results section to popup (item count, total price, unavailable list, View Cart link) | extension/popup/popup.html, extension/popup/popup.js

**Phase 2 Complete Criteria**:
- [x] Button triggers startMerge on click
- [x] 3 orders merged oldest-to-newest (replace, merge, merge)
- [x] Progress bar updates during operation
- [x] Step text shows "Merging order 1/3...", etc.
- [x] Results show item count and total
- [x] "View Cart" link opens Auchan.pt cart page

**Note**: Login detection removed - button always enabled, shows error if not on auchan.pt domain.

**Implementation Notes**:

**T004 - Multi-Order Cart Phase**:
```typescript
// Modify executeCartPhase in orchestrator
async executeCartPhase(context: PhaseContext): Promise<void> {
  // Navigate to order history
  await this.navigateToOrderHistory();
  this.updateProgress('Loading orders...', 1, 5);

  // Extract last 3 orders
  const orders = await this.extractOrderHistory(3);
  if (orders.length === 0) {
    throw new PhaseError('NO_ORDERS', 'No orders found in history');
  }

  // Sort oldest first
  const sortedOrders = orders.sort((a, b) =>
    new Date(a.date).getTime() - new Date(b.date).getTime()
  );

  // Merge each order
  for (let i = 0; i < sortedOrders.length; i++) {
    const order = sortedOrders[i];
    const mode = i === 0 ? 'replace' : 'merge';

    this.updateProgress(
      `Merging order ${i + 1}/${sortedOrders.length}...`,
      2 + i,
      2 + sortedOrders.length
    );

    await this.reorderOrder(order.orderId, order.detailUrl, mode);
  }

  // Scan final cart
  this.updateProgress('Scanning cart...', 2 + sortedOrders.length, 2 + sortedOrders.length);
  const cartSnapshot = await this.scanCart();

  // Store results
  context.cartSnapshot = cartSnapshot;
  context.cartDiff = calculateCartDiff([], cartSnapshot.items);
}
```

**T005-T008 - Popup UI**:
```html
<!-- popup.html structure -->
<div id="merge-section" class="section">
  <h2>Quick Cart Builder</h2>

  <!-- Login status (US5 - from Phase 2) -->
  <div id="login-status" class="status-indicator">...</div>

  <!-- Merge button (US1) -->
  <button id="merge-btn" class="primary-btn" disabled>
    Merge Last 3 Orders
  </button>
  <p class="hint">Populates cart with your recent purchases</p>

  <!-- Progress section (US2) -->
  <div id="progress-section" class="hidden">
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <p id="progress-text">Starting...</p>
    <button id="cancel-btn" class="secondary-btn">Cancel</button>
  </div>

  <!-- Results section (US3) -->
  <div id="results-section" class="hidden">
    <h3>Merge Complete</h3>
    <div class="stats">
      <div class="stat">
        <span class="value" id="added-count">0</span>
        <span class="label">Items Added</span>
      </div>
      <div class="stat">
        <span class="value" id="total-price">€0.00</span>
        <span class="label">Cart Total</span>
      </div>
    </div>
    <div id="unavailable-warning" class="hidden">
      <p class="warning">⚠ <span id="unavailable-count">0</span> items unavailable</p>
    </div>
    <a href="https://www.auchan.pt/pt/carrinho-compras"
       target="_blank" class="primary-btn">
      View Cart
    </a>
    <button id="new-merge-btn" class="secondary-btn">Start New Merge</button>
  </div>
</div>
```

---

## Phase 3: Polish (US4)

> Error handling and final testing.

**Sprint Allocation**: Sprint-EXT-I-002 - Polish phase
**Points**: 3 (US4: 1, Testing: 2)

### US4: Error Handling

- [x] T009 [US4] Add error section to popup with user-friendly messages and retry button | extension/popup/popup.html, extension/popup/popup.js

### Testing & Verification

- [ ] T010 [POLISH] Manual end-to-end testing on Auchan.pt and bug fixes | -

**Phase 3 Complete Criteria**:
- [x] Network error shows "Network error - please check your connection"
- [x] Selector failure shows "Unable to read page - please report this issue"
- [x] Cancel button stops operation (via cancelRun message)
- [x] Retry button restarts merge flow
- [ ] No console errors during operation (requires manual testing)
- [ ] All acceptance scenarios from spec pass (requires manual testing)

**Implementation Notes**:

**T009 - Error Display**:
```html
<!-- Add to popup.html -->
<div id="error-section" class="hidden">
  <div class="error-icon">⚠</div>
  <p class="error-text" id="error-message">An error occurred</p>
  <div class="error-actions">
    <button id="retry-btn" class="primary-btn">Retry</button>
    <button id="dismiss-btn" class="secondary-btn">Dismiss</button>
  </div>
</div>
```

```javascript
// Error message mapping in popup.js
const ERROR_MESSAGES = {
  'NO_ORDERS': 'No orders found in your history',
  'SESSION_EXPIRED': 'Session expired - please log in again',
  'NETWORK_ERROR': 'Network error - please check your connection',
  'SELECTOR_FAILED': 'Unable to read page - please report this issue',
  'CANCELLED': 'Merge cancelled',
  'TIMEOUT': 'Operation timed out - please try again',
  'default': 'An unexpected error occurred'
};

function showError(errorCode) {
  const message = ERROR_MESSAGES[errorCode] || ERROR_MESSAGES.default;
  document.getElementById('error-message').textContent = message;
  showSection('error');
}
```

---

## Execution Strategy

### Recommended: Sequential with Parallel Opportunities

1. **Phase 1 (Setup)**: T001 and T002 - DONE
2. **Phase 2 (Core)**: T003 first (test), T004 (cart phase), T005 (DONE), then T006-T008 in parallel
3. **Phase 3 (Polish)**: T009 then T010

### Critical Path

```
T001 ─┬─> T003 ─> T004 ─> T005 ─┬─> T009 ─> T010
T002 ─┘               ✓   T006 ─┤
                          T007 ─┤
                          T008 ─┘
```

### Parallelization Opportunities

| Phase | Parallel Tasks | Sequential Tasks |
|-------|----------------|------------------|
| Setup | T001, T002 (DONE) | - |
| Core | T006, T007, T008 (after T004) | T003 → T004 → T005 |
| Polish | - | T009 → T010 |

---

## Dependency Graph

```
Phase 1: Setup (DONE)
T001 ─┬─> (Extension loads in Chrome) ✓
T002 ─┘

Phase 2: Core (US1, US2, US3)
T003 ─> T004 ─> T005 ─┐
                  ✓   ├─> T006 ─> T007 ─┐
                      └─> T008 ────────┴─> (Full merge flow works)

Phase 3: Polish (US4)
T009 ─> T010 ─> (Feature complete)
```

---

## Sprint Integration Summary

### Sprint-EXT-I-002 Tasks

| Phase | Task Range | Count | Parallelizable | Points | Status |
|-------|------------|-------|----------------|--------|--------|
| Setup | T001-T002 | 2 | 2 | 1 | DONE |
| Core (US1,US2,US3) | T003-T008 | 6 | 3 | 9 | DONE |
| Polish (US4) | T009-T010 | 2 | 0 | 3 | T009 DONE, T010 PENDING |
| **Total** | | **10** | **5** | **13** | 9/10 DONE |

---

## Task-to-Sprint Mapping

> Copy to SPRINT-PLAN.md for Sprint-EXT-I-002

```markdown
## Task Breakdown (from speckit - updated)

| ID | Task | Story | Priority | Status |
|----|------|-------|----------|--------|
| T001 | Create manifest.json | SETUP | HIGH | DONE |
| T002 | Create esbuild config | SETUP | HIGH | DONE |
| T003 | Write merge flow integration test | US1 | HIGH | DONE |
| T004 | Modify cart phase for multi-order | US1 | HIGH | DONE |
| T005 | Add merge button to popup | US1 | HIGH | DONE |
| T006 | Add progress section to popup | US2 | HIGH | DONE |
| T007 | Subscribe to state updates in popup | US2 | HIGH | DONE |
| T008 | Add results section to popup | US3 | HIGH | DONE |
| T009 | Add error section to popup | US4 | MEDIUM | DONE |
| T010 | Manual E2E testing | POLISH | MEDIUM | PENDING |
```

**Note**: Original T003-T004 (login detection) removed. Tasks renumbered.

---

## Acceptance Test Checklist

> Final verification before sprint completion

### US1: Merge Button
- [x] Button always enabled (assumes user logged in)
- [x] Shows error if not on auchan.pt domain
- [x] Click triggers merge workflow
- [x] 3 orders merged in correct sequence (oldest first)
- [x] First order uses 'replace' mode
- [x] Second/third orders use 'merge' mode

### US2: Progress Feedback
- [x] Progress bar shows during operation
- [x] Step text updates for each order
- [x] Cancel button visible during operation
- [x] "Still working..." shows after 30 seconds

### US3: Results Display
- [x] Item count shown after completion
- [x] Total price shown after completion
- [x] Unavailable items count shown if any
- [x] "View Cart" link opens Auchan.pt cart

### US4: Error Handling
- [x] Network error shows retry message
- [x] Cancel stops operation promptly
- [x] Retry button restarts merge

---

<!-- SPECKIT METADATA - DO NOT EDIT BELOW -->
```yaml
speckit:
  version: "1.0"
  template: "tasks-template"
  source_plan: "001-extension-merge-orders/plan.md"
  task_summary:
    total: 10
    setup: 2
    core: 6
    polish: 2
  parallelizable: 5
  points:
    total: 13
    setup: 1
    core: 9
    polish: 3
  sprint_mapping:
    - sprint: "Sprint-EXT-I-002"
      tasks: ["T001-T010"]
  user_story_mapping:
    US1: ["T003", "T004", "T005"]
    US2: ["T006", "T007"]
    US3: ["T008"]
    US4: ["T009"]
  simplification_note: "US5 (Login Detection) removed - assumes user on Auchan.pt"
```
